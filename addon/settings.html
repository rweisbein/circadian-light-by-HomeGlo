<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circadian Light - Settings</title>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --card: #1a1a1a;
      --accent: #feac60;
      --accent-hover: #ffc078;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --line: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-right: 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand.active {
      color: var(--accent);
    }

    .nav-logo {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .nav-link {
      padding: 8px 10px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }


    /* Nav overflow menu */
    .nav-more { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: none; flex-shrink: 0; letter-spacing: 2px; line-height: 1; }
    .nav-more:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow { display: none; position: absolute; top: 100%; right: 12px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 4px 0; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 200; }
    .nav-overflow.open { display: block; }
    .nav-overflow-item { display: block; padding: 10px 16px; color: var(--muted); text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
    .nav-overflow-item:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow-item.active { color: var(--accent); }

    /* Main Content */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Settings Sections */
    .settings-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section-header {
      background: var(--panel);
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-content {
      padding: 20px;
    }

    .section-content.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Form Controls */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-label {
      min-width: 160px;
      font-size: 0.9rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-control {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-input {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      width: 200px;
    }

    .form-input:focus {
      outline: 2px solid dodgerblue;
    }

    /* Hide number input spinners to prevent accidental value changes on click */
    .form-input[type="number"]::-webkit-inner-spin-button,
    .form-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .form-input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--muted2);
      margin-left: 12px;
    }

    /* Info Icon */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 10px;
      font-style: italic;
      color: rgba(255,255,255,0.5);
      cursor: help;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      color: rgba(255,255,255,0.8);
      border-color: rgba(255,255,255,0.5);
    }

    .info-tooltip {
      display: none;
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      width: 280px;
      font-size: 0.8rem;
      font-style: normal;
      color: var(--muted);
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .info-icon:hover .info-tooltip {
      display: block;
    }

    /* Save Status */
    .save-status {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
    }

    .save-status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Checkbox */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .form-row.disabled {
      opacity: 0.5;
    }

    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Location */
    .location-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px 20px;
    }

    .location-row {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .location-fields {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .location-fields.disabled {
      opacity: 0.4;
    }

    .location-field {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--muted2);
    }

    .location-input {
      width: 80px;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .location-input:focus {
      outline: 2px solid dodgerblue;
    }

    .location-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .location-select {
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      min-width: 100px;
    }

    .location-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Filter presets */
    .filter-preset-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .filter-preset-name {
      min-width: 100px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .filter-preset-name input {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
      padding: 4px 6px;
      border-radius: 4px;
      width: 100px;
    }

    .filter-preset-name input:focus {
      border-color: var(--line);
      outline: none;
      background: var(--card);
    }

    .filter-slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .filter-slider-group label {
      font-size: 0.75rem;
      color: var(--muted2);
      min-width: 50px;
      text-align: right;
    }

    .filter-slider-group input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
      min-width: 80px;
    }

    .filter-slider-value {
      font-size: 0.8rem;
      color: var(--muted);
      min-width: 35px;
      text-align: right;
    }

    .filter-preset-delete {
      background: none;
      border: none;
      color: var(--muted2);
      cursor: pointer;
      padding: 4px;
      font-size: 1.1rem;
      line-height: 1;
      border-radius: 4px;
    }

    .filter-preset-delete:hover {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="./" class="nav-brand">
      <svg class="nav-logo" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#555"/>
        <path d="M20 1 A19 19 0 0 1 20 39 Q20 28 8 20 Q20 12 20 1" fill="#ccc"/>
        <circle cx="20" cy="12" r="5" fill="#fff"/>
        <line x1="20" y1="3" x2="20" y2="5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="27" y1="6" x2="25.5" y2="7.5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="29" y1="12" x2="27" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <path d="M16 30 A6 6 0 1 1 24 30 A4.5 4.5 0 1 0 16 30" fill="#fff"/>
      </svg>
      Home
    </a>
    <div class="nav-links">
      <a href="./switches" class="nav-link">Control</a>
      <a href="./rhythm" class="nav-link">Rhythm</a>
      <a href="./moments" class="nav-link">Magic</a>
      <a href="./tuning" class="nav-link">Tune</a>
      <a href="./settings" class="nav-link active">Settings</a>
    </div>
    <button class="nav-more" aria-label="More pages">&middot;&middot;&middot;</button>
    <div class="nav-overflow"></div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>

    <!-- General Section -->
    <div class="settings-section">
      <div class="section-header">General</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Home name
            <span class="info-icon">i<span class="info-tooltip">A display name for your home, shown as a heading on the home page.</span></span>
          </label>
          <div class="form-control">
            <input type="text" class="form-input" id="home-name" placeholder="Your home" style="width: 200px;">
          </div>
        </div>
      </div>
    </div>

    <!-- Timing Section -->
    <div class="settings-section">
      <div class="section-header">Timing</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Turn on lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns on lights, they'll smoothly turn on over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-on-transition" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Turn off lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns off lights, they'll smoothly turn off over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-off-transition" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Two-step delay
            <span class="info-icon">i<span class="info-tooltip">When turning on lights, a two-step process sets color at 1% then transitions to target brightness. This delay between steps prevents some ZigBee lights from dropping the second command. Increase if lights stay dim after turn-on.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="two-step-delay" min="0" max="20" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Multi-click
            <span class="info-icon">i<span class="info-tooltip">For switches controlled by a hub that doesn't support double-clicks, triple-clicks, etc. (e.g. the Philips Hue Hub), enabling turns on Circadian Light detection of multi-clicks. Single-click actions will be delayed by the multi-click speed while waiting for additional clicks.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="multi-click-enabled">
            </label>
            <span id="multi-click-speed-group" style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
              <span class="form-hint" style="margin-left: 0;">Speed</span>
              <input type="number" class="form-input" id="multi-click-speed" min="1" max="100" step="0.1" value="10" style="width: 60px;">
              <span class="form-hint">tenths of a second</span>
            </span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Long-press repeat interval
            <span class="info-icon">i<span class="info-tooltip">How fast brightness changes when holding up/down buttons on a switch. Lower values = faster ramping.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="long-press-repeat-interval" min="1" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Reach adjustment learn mode
            <span class="info-icon">i<span class="info-tooltip">When enabled, all lights in the reach areas fade out and back so you can see which areas are included. When disabled, only a single indicator light flashes (1x/2x/3x for each reach level). Configure the indicator light per-switch in the Controls page.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="reach-learn-mode" checked>
            </label>
            <span class="form-hint" style="margin-left: 12px;">Flash all area lights to show reach contents</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Circadian refresh
            <span class="info-icon">i<span class="info-tooltip">How often Circadian Light updates lights to match the current sun position. Timers (motion, boost) are checked every second regardless of this setting. Lower values give smoother light transitions but increase Home Assistant API calls.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="circadian-refresh" min="5" max="120" step="5" value="30" style="width: 80px;">
            <span class="form-hint">seconds (5-120)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Home page refresh
            <span class="info-icon">i<span class="info-tooltip">How often the home page area cards refresh to show current brightness, color temperature, and on/off state. Lower values show changes faster but increase browser network activity. The area modal always refreshes every 1 second regardless of this setting.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="home-refresh-interval" min="2" max="60" step="1" value="10" style="width: 80px;">
            <span class="form-hint">seconds (2-60)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Log periodic updates
            <span class="info-icon">i<span class="info-tooltip">When enabled, logs detailed info about every periodic light update cycle (per-area brightness/color values, group breakdowns, off enforcement). When disabled, only errors, warnings, and user-triggered actions are logged. Useful for debugging but very verbose.</span></span>
          </label>
          <div class="form-control">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="log-periodic" style="width: 18px; height: 18px;">
              <span class="form-hint">Enable verbose periodic logging</span>
            </label>
          </div>
        </div>

        <div class="form-row" style="margin-top: 10px;">
          <label class="form-label">
            Sync devices
            <span class="info-icon">i<span class="info-tooltip">Re-scans Home Assistant for new or moved lights, areas, and ZHA devices. Only needed after adding or moving hardware. This does not run automatically.</span></span>
          </label>
          <div class="form-control">
            <button type="button" class="btn" id="sync-devices-btn" onclick="syncDevices()" style="padding: 6px 16px; cursor: pointer;">Sync now</button>
            <span class="form-hint" id="sync-status"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Visual Feedback Section -->
    <div class="settings-section">
      <div class="section-header">Visual Feedback</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Motion warning time
            <span class="info-icon">i<span class="info-tooltip">How long before the motion timer expires to trigger a warning dim. Set to 0 to disable motion warnings. The warning dims lights to alert you before they turn off.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-time" min="0" max="120" step="5" value="0" style="width: 80px;">
            <span class="form-hint">seconds before off (0 = disabled)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning blink threshold
            <span class="info-icon">i<span class="info-tooltip">At low brightness levels, a simple dim may not be noticeable. Below this threshold, the warning will briefly blink off (0% for 300ms) before dimming to ensure you notice. Formula: above threshold dims to 50% of current; below threshold blinks then dims to 3%.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-blink-threshold" min="5" max="50" step="1" value="15" style="width: 80px;">
            <span class="form-hint">% brightness</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Freeze off rise speed
            <span class="info-icon">i<span class="info-tooltip">When unfreezing, lights rise back to circadian values over this amount of time. A slower rise gives a gentle visual confirmation that the area has been unfrozen.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="freeze-off-rise" min="0" max="100" step="0.1" value="10" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit warning speed
            <span class="info-icon">i<span class="info-tooltip">When stepping up/down hits the brightness or color limit, lights bounce to indicate the limit. This controls how fast the bounce animation plays.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-warning-speed" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (max)
            <span class="info-icon">i<span class="info-tooltip">How much to dip when hitting the upper limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-max-percent" min="5" max="50" step="1" value="30" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (min)
            <span class="info-icon">i<span class="info-tooltip">How much to flash when hitting the lower limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-min-percent" min="5" max="50" step="1" value="10" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Reach feedback dip
            <span class="info-icon">i<span class="info-tooltip">How much lights dip during reach change feedback. Expressed as a percentage of current brightness.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="reach-dip-percent" min="10" max="80" step="5" value="50" style="width: 80px;">
            <span class="form-hint">% of current</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Light Properties Section -->
    <div class="settings-section">
      <div class="section-header">Light Properties</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Boost default
            <span class="info-icon">i<span class="info-tooltip">When using the Boost action, lights will temporarily increase to maximum brightness plus this percentage offset from their current position. The boost will expire and return to normal circadian values.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="boost-default" min="10" max="100" step="5" value="30" style="width: 80px;">
            <span class="form-hint">%</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">
            Daylight saturation
            <span class="info-icon">i<span class="info-tooltip">Sun elevation (in degrees) at which daylight is considered fully effective for natural light reduction. Lower values mean lights turn off earlier in the morning and later in the evening for rooms with natural light exposure. Default 8° works well for most homes.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="daylight-saturation-deg" min="2" max="30" step="1" value="8" style="width: 80px;">
            <span class="form-hint">°</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Outdoor Lux Sensor Section -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-header-left">
          Outdoor Lux Sensor
          <span class="info-icon">i<span class="info-tooltip">An outdoor illuminance sensor provides a "reality check" for sun-dependent features. On cloudy/stormy days the system reduces natural light dimming and cool day color shifting so lights stay bright and warm when it's dark outside. Without a sensor, sun_factor is always 1.0 (current behavior).</span></span>
        </div>
      </div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Sensor entity
            <span class="info-icon">i<span class="info-tooltip">The entity_id of an outdoor illuminance sensor in Home Assistant (e.g. sensor.outdoor_illuminance). Leave empty to disable lux-based modulation.</span></span>
          </label>
          <div class="form-control">
            <select class="form-input" id="outdoor-lux-sensor" style="width: 280px;">
              <option value="">None (disabled)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">
            Smoothing interval
            <span class="info-icon">i<span class="info-tooltip">EMA (exponential moving average) time constant in seconds. Higher values smooth out rapid lux changes (clouds passing). Set to 0 for no smoothing (raw values).</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="lux-smoothing-interval" min="0" max="3600" step="30" value="300" style="width: 80px;">
            <span class="form-hint">s</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">
            Learned ceiling
            <span class="info-icon">i<span class="info-tooltip">Bright-day lux baseline (85th percentile of daytime readings). Learned automatically from 90 days of sensor history. You can override with a manual value.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="lux-learned-ceiling" min="1" max="200000" step="100" placeholder="auto" style="width: 100px;">
            <span class="form-hint">lux</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">
            Learned floor
            <span class="info-icon">i<span class="info-tooltip">Dark-day lux baseline (5th percentile of daytime readings). Learned automatically from 90 days of sensor history. You can override with a manual value.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="lux-learned-floor" min="1" max="200000" step="10" placeholder="auto" style="width: 100px;">
            <span class="form-hint">lux</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CT Brightness Compensation Section -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-header-left">
          CT Brightness Compensation
          <span class="info-icon">i<span class="info-tooltip">Compensates for brightness loss when Hue bulbs transition from efficient warm-white LEDs to less efficient RGB LEDs at very warm color temperatures. The "handover zone" is where this transition occurs.</span></span>
        </div>
        <label class="checkbox-label" style="font-weight: normal;">
          <input type="checkbox" id="ct-comp-enabled">
          <span style="font-size: 0.85rem;">Enabled</span>
        </label>
      </div>
      <div class="section-content" id="ct-comp-content">
        <div class="form-row">
          <label class="form-label">
            Handover begin
            <span class="info-icon">i<span class="info-tooltip">The warmer (lower) end of the handover zone where RGB LEDs take over completely. Below this temperature, compensation is capped at the max factor.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-begin" min="500" max="2500" step="50" value="1650" style="width: 100px;">
            <span class="form-hint">K</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Handover end
            <span class="info-icon">i<span class="info-tooltip">The cooler (higher) end of the handover zone where warm-white LEDs are still efficient. Above this temperature, no compensation is applied.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-end" min="1500" max="3500" step="50" value="2250" style="width: 100px;">
            <span class="form-hint">K</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Max compensation
            <span class="info-icon">i<span class="info-tooltip">The brightness multiplier applied at and below the handover begin temperature. 1.4 means brightness is boosted by 40% to counteract the perceived dimming.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-factor" min="1.0" max="2.0" step="0.05" value="1.4" style="width: 100px;">
            <span class="form-hint">× (1.0 = none, 1.4 = 40% boost)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Light Filters Section -->
    <div class="settings-section">
      <div class="section-header">Light Filters</div>
      <div class="section-content">
        <div id="filter-presets-container">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <label class="form-label" style="min-width: auto;">
              Filter presets
              <span class="info-icon">i<span class="info-tooltip">Define brightness curve modifiers for different light roles. "at bright" is the multiplier when the circadian curve is at maximum brightness. "at dim" is the multiplier at minimum. Values interpolate linearly between. 100% = no change, 0% = off, 200% = double (capped at 100% final).</span></span>
            </label>
            <button type="button" class="btn" id="add-preset-btn" onclick="addFilterPreset()" style="padding: 4px 12px; cursor: pointer; font-size: 0.85rem;">+ Add preset</button>
          </div>
          <div id="filter-presets-list"></div>
        </div>
      </div>
    </div>

    <!-- Location Section -->
    <div class="settings-section">
      <div class="section-header">Location</div>
      <div class="section-content">
        <div class="location-section" id="location-section">
          <div class="location-row">
            <label class="checkbox-label">
              <input type="checkbox" id="use-ha-location" checked>
              <span>Use Home Assistant location</span>
            </label>
            <div class="location-fields" id="location-fields">
              <div class="location-field">
                <span class="field-label">Lat</span>
                <input type="number" class="location-input" id="latitude" step="0.0001" placeholder="40.71" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">Long</span>
                <input type="number" class="location-input" id="longitude" step="0.0001" placeholder="-74.00" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">TZ</span>
                <select class="location-select" id="timezone" disabled>
                  <option value="US/Eastern">US/Eastern</option>
                  <option value="US/Central">US/Central</option>
                  <option value="US/Mountain">US/Mountain</option>
                  <option value="US/Pacific">US/Pacific</option>
                  <option value="US/Alaska">US/Alaska</option>
                  <option value="US/Hawaii">US/Hawaii</option>
                  <option value="Europe/London">Europe/London</option>
                  <option value="Europe/Paris">Europe/Paris</option>
                  <option value="Europe/Berlin">Europe/Berlin</option>
                  <option value="Asia/Tokyo">Asia/Tokyo</option>
                  <option value="Asia/Shanghai">Asia/Shanghai</option>
                  <option value="Australia/Sydney">Australia/Sydney</option>
                  <option value="UTC">UTC</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="save-status" id="save-status">Settings saved</div>
  </main>

  <script src="./shared.js"></script>
  <script>
    // Load and save settings
    async function loadSettings() {
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          document.getElementById('home-name').value = config.home_name ?? 'Your home';
          document.getElementById('turn-on-transition').value = config.turn_on_transition ?? 3;
          document.getElementById('turn-off-transition').value = config.turn_off_transition ?? 3;
          document.getElementById('two-step-delay').value = config.two_step_delay ?? 3;
          document.getElementById('multi-click-enabled').checked = config.multi_click_enabled ?? true;
          document.getElementById('multi-click-speed').value = config.multi_click_speed ?? 10;
          document.getElementById('long-press-repeat-interval').value = config.long_press_repeat_interval ?? 3;
          document.getElementById('reach-learn-mode').checked = config.reach_learn_mode ?? true;
          document.getElementById('circadian-refresh').value = config.circadian_refresh ?? 30;
          document.getElementById('home-refresh-interval').value = config.home_refresh_interval ?? 10;
          document.getElementById('log-periodic').checked = config.log_periodic ?? false;
          document.getElementById('motion-warning-time').value = config.motion_warning_time ?? 0;
          document.getElementById('motion-warning-blink-threshold').value = config.motion_warning_blink_threshold ?? 15;
          document.getElementById('freeze-off-rise').value = config.freeze_off_rise ?? 10;
          document.getElementById('limit-warning-speed').value = config.limit_warning_speed ?? 3;
          document.getElementById('limit-bounce-max-percent').value = config.limit_bounce_max_percent ?? 30;
          document.getElementById('limit-bounce-min-percent').value = config.limit_bounce_min_percent ?? 10;
          document.getElementById('reach-dip-percent').value = config.reach_dip_percent ?? 50;
          document.getElementById('boost-default').value = config.boost_default ?? 30;
          document.getElementById('daylight-saturation-deg').value = config.daylight_saturation_deg ?? 8;
          // Populate lux sensor dropdown
          const luxSelect = document.getElementById('outdoor-lux-sensor');
          const savedSensor = config.outdoor_lux_sensor ?? '';
          try {
            const sensorsRes = await fetch('./api/sensors?device_class=illuminance');
            if (sensorsRes.ok) {
              const sensorsData = await sensorsRes.json();
              // Clear existing options except "None"
              luxSelect.innerHTML = '<option value="">None (disabled)</option>';
              for (const s of sensorsData.sensors || []) {
                const opt = document.createElement('option');
                opt.value = s.entity_id;
                opt.textContent = s.name + (s.state ? ' (' + s.state + ' ' + (s.unit || '') + ')' : '');
                luxSelect.appendChild(opt);
              }
            }
          } catch (e) { console.warn('Could not load illuminance sensors:', e); }
          // If saved value isn't in list (e.g. sensor removed), add it so selection is preserved
          if (savedSensor && !luxSelect.querySelector('option[value="' + CSS.escape(savedSensor) + '"]')) {
            const opt = document.createElement('option');
            opt.value = savedSensor;
            opt.textContent = savedSensor + ' (not found)';
            luxSelect.appendChild(opt);
          }
          luxSelect.value = savedSensor;
          document.getElementById('lux-smoothing-interval').value = config.lux_smoothing_interval ?? 300;
          document.getElementById('lux-learned-ceiling').value = config.lux_learned_ceiling ?? '';
          document.getElementById('lux-learned-floor').value = config.lux_learned_floor ?? '';
          document.getElementById('ct-comp-enabled').checked = config.ct_comp_enabled ?? false;
          document.getElementById('ct-comp-begin').value = config.ct_comp_begin ?? 1650;
          document.getElementById('ct-comp-end').value = config.ct_comp_end ?? 2250;
          document.getElementById('ct-comp-factor').value = config.ct_comp_factor ?? 1.4;
          updateMultiClickState();
          updateCtCompState();
          updateLocationSection(config);
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function saveSettings() {
      const settings = {
        home_name: document.getElementById('home-name').value.trim(),
        turn_on_transition: parseFloat(document.getElementById('turn-on-transition').value) || 3,
        turn_off_transition: parseFloat(document.getElementById('turn-off-transition').value) || 3,
        two_step_delay: parseFloat(document.getElementById('two-step-delay').value) || 3,
        multi_click_enabled: document.getElementById('multi-click-enabled').checked,
        multi_click_speed: parseFloat(document.getElementById('multi-click-speed').value) || 10,
        long_press_repeat_interval: parseFloat(document.getElementById('long-press-repeat-interval').value) || 3,
        reach_learn_mode: document.getElementById('reach-learn-mode').checked,
        circadian_refresh: parseInt(document.getElementById('circadian-refresh').value) || 30,
        home_refresh_interval: parseInt(document.getElementById('home-refresh-interval').value) || 10,
        log_periodic: document.getElementById('log-periodic').checked,
        motion_warning_time: parseInt(document.getElementById('motion-warning-time').value) || 0,
        motion_warning_blink_threshold: parseInt(document.getElementById('motion-warning-blink-threshold').value) || 15,
        freeze_off_rise: parseFloat(document.getElementById('freeze-off-rise').value) || 10,
        limit_warning_speed: parseFloat(document.getElementById('limit-warning-speed').value) || 3,
        limit_bounce_max_percent: parseInt(document.getElementById('limit-bounce-max-percent').value) || 30,
        limit_bounce_min_percent: parseInt(document.getElementById('limit-bounce-min-percent').value) || 10,
        reach_dip_percent: parseInt(document.getElementById('reach-dip-percent').value) || 50,
        boost_default: parseInt(document.getElementById('boost-default').value) || 30,
        daylight_saturation_deg: parseInt(document.getElementById('daylight-saturation-deg').value) || 8,
        outdoor_lux_sensor: document.getElementById('outdoor-lux-sensor').value.trim() || null,
        lux_smoothing_interval: parseInt(document.getElementById('lux-smoothing-interval').value) || 300,
        lux_learned_ceiling: parseFloat(document.getElementById('lux-learned-ceiling').value) || null,
        lux_learned_floor: parseFloat(document.getElementById('lux-learned-floor').value) || null,
        ct_comp_enabled: document.getElementById('ct-comp-enabled').checked,
        ct_comp_begin: parseInt(document.getElementById('ct-comp-begin').value) || 1650,
        ct_comp_end: parseInt(document.getElementById('ct-comp-end').value) || 2250,
        ct_comp_factor: parseFloat(document.getElementById('ct-comp-factor').value) || 1.4
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving settings:', err);
      }
    }

    function updateMultiClickState() {
      const enabled = document.getElementById('multi-click-enabled').checked;
      const speedGroup = document.getElementById('multi-click-speed-group');
      const speedInput = document.getElementById('multi-click-speed');

      if (enabled) {
        speedGroup.style.opacity = '1';
        speedInput.disabled = false;
      } else {
        speedGroup.style.opacity = '0.4';
        speedInput.disabled = true;
      }
    }

    function updateCtCompState() {
      const enabled = document.getElementById('ct-comp-enabled').checked;
      const content = document.getElementById('ct-comp-content');
      if (enabled) {
        content.classList.remove('disabled');
      } else {
        content.classList.add('disabled');
      }
    }

    async function syncDevices() {
      const btn = document.getElementById('sync-devices-btn');
      const status = document.getElementById('sync-status');
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      status.textContent = '';
      try {
        const response = await fetch('./api/sync-devices', { method: 'POST' });
        const result = await response.json();
        if (response.ok) {
          status.textContent = 'Sync complete';
          status.style.color = '#4caf50';
        } else {
          status.textContent = result.error || 'Sync failed';
          status.style.color = '#f44336';
        }
      } catch (err) {
        status.textContent = 'Sync failed';
        status.style.color = '#f44336';
        console.error('Error syncing devices:', err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync now';
        setTimeout(() => { status.textContent = ''; }, 5000);
      }
    }

    function showSaveStatus() {
      const status = document.getElementById('save-status');
      status.classList.add('visible');
      setTimeout(() => status.classList.remove('visible'), 2000);
    }

    // Auto-save on blur for number inputs (avoids decrement bug on focus)
    document.getElementById('home-name').addEventListener('blur', saveSettings);
    document.getElementById('turn-on-transition').addEventListener('blur', saveSettings);
    document.getElementById('turn-off-transition').addEventListener('blur', saveSettings);
    document.getElementById('two-step-delay').addEventListener('blur', saveSettings);
    document.getElementById('multi-click-enabled').addEventListener('change', () => {
      updateMultiClickState();
      saveSettings();
    });
    document.getElementById('multi-click-speed').addEventListener('blur', saveSettings);
    document.getElementById('long-press-repeat-interval').addEventListener('blur', saveSettings);
    document.getElementById('reach-learn-mode').addEventListener('change', saveSettings);
    document.getElementById('circadian-refresh').addEventListener('blur', saveSettings);
    document.getElementById('home-refresh-interval').addEventListener('blur', saveSettings);
    document.getElementById('log-periodic').addEventListener('change', saveSettings);
    document.getElementById('motion-warning-time').addEventListener('blur', saveSettings);
    document.getElementById('motion-warning-blink-threshold').addEventListener('blur', saveSettings);
    document.getElementById('freeze-off-rise').addEventListener('blur', saveSettings);
    document.getElementById('limit-warning-speed').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-max-percent').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-min-percent').addEventListener('blur', saveSettings);
    document.getElementById('reach-dip-percent').addEventListener('blur', saveSettings);
    document.getElementById('boost-default').addEventListener('blur', saveSettings);
    document.getElementById('daylight-saturation-deg').addEventListener('blur', saveSettings);
    document.getElementById('outdoor-lux-sensor').addEventListener('change', saveSettings);
    document.getElementById('lux-smoothing-interval').addEventListener('blur', saveSettings);
    document.getElementById('lux-learned-ceiling').addEventListener('blur', saveSettings);
    document.getElementById('lux-learned-floor').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-enabled').addEventListener('change', () => {
      updateCtCompState();
      saveSettings();
    });
    document.getElementById('ct-comp-begin').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-end').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-factor').addEventListener('blur', saveSettings);

    // Location functions
    function updateLocationSection(config) {
      const useHA = config.use_ha_location !== false;
      document.getElementById('use-ha-location').checked = useHA;
      document.getElementById('latitude').value = config.latitude || '';
      document.getElementById('longitude').value = config.longitude || '';
      document.getElementById('timezone').value = config.timezone || 'US/Eastern';
      updateLocationInputsState(useHA);
    }

    function updateLocationInputsState(useHA) {
      const fields = document.getElementById('location-fields');
      const inputs = fields.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = useHA);
      if (useHA) {
        fields.classList.add('disabled');
      } else {
        fields.classList.remove('disabled');
      }
    }

    async function saveLocationSettings() {
      const settings = {
        use_ha_location: document.getElementById('use-ha-location').checked,
        latitude: parseFloat(document.getElementById('latitude').value) || null,
        longitude: parseFloat(document.getElementById('longitude').value) || null,
        timezone: document.getElementById('timezone').value
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving location:', err);
      }
    }

    document.getElementById('use-ha-location').addEventListener('change', (e) => {
      updateLocationInputsState(e.target.checked);
      saveLocationSettings();
    });

    ['latitude', 'longitude', 'timezone'].forEach(id => {
      document.getElementById(id).addEventListener('change', saveLocationSettings);
    });

    // ---- Light Filters ----
    let filterPresets = {};

    function renderFilterPresets() {
      const container = document.getElementById('filter-presets-list');
      container.innerHTML = '';
      for (const [name, preset] of Object.entries(filterPresets)) {
        const isStandard = name === 'Standard';
        const row = document.createElement('div');
        row.className = 'filter-preset-row';
        row.innerHTML = `
          <div class="filter-preset-name">
            ${isStandard ? `<span>${name}</span>` : `<input type="text" value="${name}" data-orig="${name}" onblur="renamePreset(this)" />`}
          </div>
          <div class="filter-slider-group">
            <label>at bright</label>
            <input type="range" min="0" max="200" step="1" value="${preset.at_bright}" oninput="updatePresetSlider(this, '${name}', 'at_bright')">
            <span class="filter-slider-value">${preset.at_bright}%</span>
          </div>
          <div class="filter-slider-group">
            <label>at dim</label>
            <input type="range" min="0" max="200" step="1" value="${preset.at_dim}" oninput="updatePresetSlider(this, '${name}', 'at_dim')">
            <span class="filter-slider-value">${preset.at_dim}%</span>
          </div>
          <div class="filter-slider-group">
            <label>off below</label>
            <input type="range" min="0" max="20" step="1" value="${preset.off_threshold ?? 3}" oninput="updatePresetSlider(this, '${name}', 'off_threshold')">
            <span class="filter-slider-value">${preset.off_threshold ?? 3}%</span>
          </div>
          ${isStandard ? '<div style="width:28px"></div>' : `<button class="filter-preset-delete" onclick="deletePreset('${name}')" title="Delete preset">&times;</button>`}
        `;
        container.appendChild(row);
      }
    }

    function updatePresetSlider(slider, presetName, field) {
      slider.nextElementSibling.textContent = slider.value + '%';
      filterPresets[presetName][field] = parseInt(slider.value);
      saveFilterPresets();
    }

    function renamePreset(input) {
      const orig = input.dataset.orig;
      const newName = input.value.trim();
      if (!newName || newName === orig) {
        input.value = orig;
        return;
      }
      if (filterPresets[newName]) {
        input.value = orig;
        return;
      }
      const data = filterPresets[orig];
      delete filterPresets[orig];
      filterPresets[newName] = data;
      renderFilterPresets();
      saveFilterPresets();
    }

    async function deletePreset(name) {
      if (name === 'Standard') return;

      // Check if any lights are assigned to this preset
      let usageLines = [];
      try {
        const resp = await fetch('./api/light-filters');
        if (resp.ok) {
          const data = await resp.json();
          const areaLights = data.area_lights || {};
          for (const [zoneName, zone] of Object.entries(data.zones || {})) {
            for (const area of zone.areas || []) {
              const filters = area.light_filters || {};
              const matching = Object.entries(filters)
                .filter(([eid, preset]) => preset === name)
                .map(([eid]) => {
                  const lights = areaLights[area.id] || [];
                  const found = lights.find(l => l.entity_id === eid);
                  return found ? found.name : eid;
                });
              if (matching.length > 0) {
                usageLines.push(`- ${area.name}: ${matching.join(', ')}`);
              }
            }
          }
        }
      } catch (e) {
        // If fetch fails, proceed with simple confirm
      }

      if (usageLines.length > 0) {
        const count = usageLines.reduce((n, line) => n + (line.match(/,/g) || []).length + 1, 0);
        const msg = `"${name}" is assigned to ${count} light${count !== 1 ? 's' : ''}:\n${usageLines.join('\n')}\n\nDelete and reassign these lights to Standard?`;
        if (!confirm(msg)) return;
        try {
          await fetch('./api/light-filters/reassign-preset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({from_preset: name, to_preset: 'Standard'})
          });
        } catch (e) {
          alert('Failed to reassign lights: ' + e.message);
          return;
        }
      } else {
        if (!confirm(`Delete "${name}"?`)) return;
      }

      delete filterPresets[name];
      renderFilterPresets();
      saveFilterPresets();
    }

    function addFilterPreset() {
      let name = 'Custom';
      let i = 1;
      while (filterPresets[name]) { name = 'Custom ' + (++i); }
      filterPresets[name] = { at_bright: 100, at_dim: 100, off_threshold: 3 };
      renderFilterPresets();
      saveFilterPresets();
    }

    async function saveFilterPresets() {
      const lightFilters = {
        presets: filterPresets
      };
      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ light_filters: lightFilters })
        });
        if (response.ok) showSaveStatus();
      } catch (err) {
        console.error('Error saving filter presets:', err);
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSettings();
      // Load filter presets
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          const lf = config.light_filters || {};
          filterPresets = lf.presets || {
            "Standard": {"at_bright": 100, "at_dim": 100, "off_threshold": 3},
            "Overhead": {"at_bright": 100, "at_dim": 0, "off_threshold": 3},
            "Lamp": {"at_bright": 30, "at_dim": 100, "off_threshold": 3},
            "Accent": {"at_bright": 50, "at_dim": 50, "off_threshold": 3},
            "Nightlight": {"at_bright": 0, "at_dim": 40, "off_threshold": 3}
          };
          renderFilterPresets();
        }
      } catch (err) {
        console.error('Error loading filter presets:', err);
      }
    });
  </script>
</body>
</html>
