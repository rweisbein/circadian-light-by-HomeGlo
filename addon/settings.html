<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circadian Light - Settings</title>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --card: #1a1a1a;
      --accent: #feac60;
      --accent-hover: #ffc078;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --line: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-right: 32px;
      text-decoration: none;
    }

    .nav-brand.active {
      color: var(--accent);
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 8px 16px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .nav-link-2line {
      line-height: 1.15;
      padding: 6px 12px;
    }

    /* Nav solar display */
    .nav-solar { margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--muted); opacity: 0; transition: opacity 0.3s; }
    .nav-solar-icon { width: 22px; height: 22px; flex-shrink: 0; }
    .nav-solar-times { display: flex; flex-direction: column; line-height: 1.3; }

    /* Main Content */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Settings Sections */
    .settings-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section-header {
      background: var(--panel);
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-content {
      padding: 20px;
    }

    .section-content.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Form Controls */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-label {
      min-width: 160px;
      font-size: 0.9rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-control {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-input {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      width: 200px;
    }

    .form-input:focus {
      outline: 2px solid var(--accent);
    }

    /* Hide number input spinners to prevent accidental value changes on click */
    .form-input[type="number"]::-webkit-inner-spin-button,
    .form-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .form-input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--muted2);
      margin-left: 12px;
    }

    /* Info Icon */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 10px;
      font-style: italic;
      color: rgba(255,255,255,0.5);
      cursor: help;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      color: rgba(255,255,255,0.8);
      border-color: rgba(255,255,255,0.5);
    }

    .info-tooltip {
      display: none;
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      width: 280px;
      font-size: 0.8rem;
      font-style: normal;
      color: var(--muted);
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .info-icon:hover .info-tooltip {
      display: block;
    }

    /* Save Status */
    .save-status {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
    }

    .save-status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Checkbox */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .form-row.disabled {
      opacity: 0.5;
    }

    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Location */
    .location-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px 20px;
    }

    .location-row {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .location-fields {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .location-fields.disabled {
      opacity: 0.4;
    }

    .location-field {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--muted2);
    }

    .location-input {
      width: 80px;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .location-input:focus {
      outline: 2px solid var(--accent);
    }

    .location-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .location-select {
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      min-width: 100px;
    }

    .location-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="./" class="nav-brand">Circadian Light</a>
    <div class="nav-links">
      <a href="./rhythm" class="nav-link nav-link-2line">Daily Rhythm</a>
      <a href="./switches" class="nav-link">Controls</a>
      <a href="./moments" class="nav-link">Moments</a>
      <a href="./settings" class="nav-link active">Settings</a>
    </div>
    <div class="nav-solar" id="nav-solar">
      <svg class="nav-solar-icon" viewBox="0 0 20 20" fill="none" stroke="#ffd050" stroke-width="1.5"><circle cx="10" cy="10" r="4"/><line x1="10" y1="1.5" x2="10" y2="3.5"/><line x1="10" y1="16.5" x2="10" y2="18.5"/><line x1="1.5" y1="10" x2="3.5" y2="10"/><line x1="16.5" y1="10" x2="18.5" y2="10"/><line x1="4" y1="4" x2="5.5" y2="5.5"/><line x1="14.5" y1="14.5" x2="16" y2="16"/><line x1="4" y1="16" x2="5.5" y2="14.5"/><line x1="14.5" y1="5.5" x2="16" y2="4"/></svg>
      <div class="nav-solar-times">
        <span id="nav-rise">--</span>
        <span id="nav-set">--</span>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>

    <!-- Timing Section -->
    <div class="settings-section">
      <div class="section-header">Timing</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Turn on lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns on lights, they'll smoothly turn on over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-on-transition" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Turn off lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns off lights, they'll smoothly turn off over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-off-transition" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Two-step delay
            <span class="info-icon">i<span class="info-tooltip">When turning on lights, a two-step process sets color at 1% then transitions to target brightness. This delay between steps prevents some ZigBee lights from dropping the second command. Increase if lights stay dim after turn-on.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="two-step-delay" min="0" max="20" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Multi-click
            <span class="info-icon">i<span class="info-tooltip">For switches controlled by a hub that doesn't support double-clicks, triple-clicks, etc. (e.g. the Philips Hue Hub), enabling turns on Circadian Light detection of multi-clicks. Single-click actions will be delayed by the multi-click speed while waiting for additional clicks.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="multi-click-enabled">
            </label>
            <span id="multi-click-speed-group" style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
              <span class="form-hint" style="margin-left: 0;">Speed</span>
              <input type="number" class="form-input" id="multi-click-speed" min="1" max="100" step="0.1" value="10" style="width: 60px;">
              <span class="form-hint">tenths of a second</span>
            </span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Long-press repeat interval
            <span class="info-icon">i<span class="info-tooltip">How fast brightness changes when holding up/down buttons on a switch. Lower values = faster ramping.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="long-press-repeat-interval" min="1" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Reach adjustment learn mode
            <span class="info-icon">i<span class="info-tooltip">When enabled, all lights in the reach areas fade out and back so you can see which areas are included. When disabled, only a single indicator light flashes (1x/2x/3x for each reach level). Configure the indicator light per-switch in the Controls page.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="reach-learn-mode" checked>
            </label>
            <span class="form-hint" style="margin-left: 12px;">Flash all area lights to show reach contents</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Circadian refresh
            <span class="info-icon">i<span class="info-tooltip">How often Circadian Light updates lights to match the current sun position. Timers (motion, boost) are checked every second regardless of this setting. Lower values give smoother light transitions but increase Home Assistant API calls.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="circadian-refresh" min="5" max="120" step="5" value="30" style="width: 80px;">
            <span class="form-hint">seconds (5-120)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Home page refresh
            <span class="info-icon">i<span class="info-tooltip">How often the home page area cards refresh to show current brightness, color temperature, and on/off state. Lower values show changes faster but increase browser network activity. The area modal always refreshes every 1 second regardless of this setting.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="home-refresh-interval" min="2" max="60" step="1" value="10" style="width: 80px;">
            <span class="form-hint">seconds (2-60)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Log periodic updates
            <span class="info-icon">i<span class="info-tooltip">When enabled, logs detailed info about every periodic light update cycle (per-area brightness/color values, group breakdowns, off enforcement). When disabled, only errors, warnings, and user-triggered actions are logged. Useful for debugging but very verbose.</span></span>
          </label>
          <div class="form-control">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="log-periodic" style="width: 18px; height: 18px;">
              <span class="form-hint">Enable verbose periodic logging</span>
            </label>
          </div>
        </div>

        <div class="form-row" style="margin-top: 10px;">
          <label class="form-label">
            Sync devices
            <span class="info-icon">i<span class="info-tooltip">Re-scans Home Assistant for new or moved lights, areas, and ZHA devices. Only needed after adding or moving hardware. This does not run automatically.</span></span>
          </label>
          <div class="form-control">
            <button type="button" class="btn" id="sync-devices-btn" onclick="syncDevices()" style="padding: 6px 16px; cursor: pointer;">Sync now</button>
            <span class="form-hint" id="sync-status"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Visual Feedback Section -->
    <div class="settings-section">
      <div class="section-header">Visual Feedback</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Motion warning time
            <span class="info-icon">i<span class="info-tooltip">How long before the motion timer expires to trigger a warning dim. Set to 0 to disable motion warnings. The warning dims lights to alert you before they turn off.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-time" min="0" max="120" step="5" value="0" style="width: 80px;">
            <span class="form-hint">seconds before off (0 = disabled)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning blink threshold
            <span class="info-icon">i<span class="info-tooltip">At low brightness levels, a simple dim may not be noticeable. Below this threshold, the warning will briefly blink off (0% for 300ms) before dimming to ensure you notice. Formula: above threshold dims to 50% of current; below threshold blinks then dims to 3%.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-blink-threshold" min="5" max="50" step="1" value="15" style="width: 80px;">
            <span class="form-hint">% brightness</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Freeze off rise speed
            <span class="info-icon">i<span class="info-tooltip">When unfreezing, lights rise back to circadian values over this amount of time. A slower rise gives a gentle visual confirmation that the area has been unfrozen.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="freeze-off-rise" min="0" max="100" step="0.1" value="10" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit warning speed
            <span class="info-icon">i<span class="info-tooltip">When stepping up/down hits the brightness or color limit, lights bounce to indicate the limit. This controls how fast the bounce animation plays.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-warning-speed" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (max)
            <span class="info-icon">i<span class="info-tooltip">How much to dip when hitting the upper limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-max-percent" min="5" max="50" step="1" value="30" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (min)
            <span class="info-icon">i<span class="info-tooltip">How much to flash when hitting the lower limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-min-percent" min="5" max="50" step="1" value="10" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Reach feedback dip
            <span class="info-icon">i<span class="info-tooltip">How much lights dip during reach change feedback. Expressed as a percentage of current brightness.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="reach-dip-percent" min="10" max="80" step="5" value="50" style="width: 80px;">
            <span class="form-hint">% of current</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Light Properties Section -->
    <div class="settings-section">
      <div class="section-header">Light Properties</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Boost default
            <span class="info-icon">i<span class="info-tooltip">When using the Boost action, lights will temporarily increase to maximum brightness plus this percentage offset from their current position. The boost will expire and return to normal circadian values.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="boost-default" min="10" max="100" step="5" value="30" style="width: 80px;">
            <span class="form-hint">%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Section -->
    <div class="settings-section">
      <div class="section-header">Location</div>
      <div class="section-content">
        <div class="location-section" id="location-section">
          <div class="location-row">
            <label class="checkbox-label">
              <input type="checkbox" id="use-ha-location" checked>
              <span>Use Home Assistant location</span>
            </label>
            <div class="location-fields" id="location-fields">
              <div class="location-field">
                <span class="field-label">Lat</span>
                <input type="number" class="location-input" id="latitude" step="0.0001" placeholder="40.71" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">Long</span>
                <input type="number" class="location-input" id="longitude" step="0.0001" placeholder="-74.00" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">TZ</span>
                <select class="location-select" id="timezone" disabled>
                  <option value="US/Eastern">US/Eastern</option>
                  <option value="US/Central">US/Central</option>
                  <option value="US/Mountain">US/Mountain</option>
                  <option value="US/Pacific">US/Pacific</option>
                  <option value="US/Alaska">US/Alaska</option>
                  <option value="US/Hawaii">US/Hawaii</option>
                  <option value="Europe/London">Europe/London</option>
                  <option value="Europe/Paris">Europe/Paris</option>
                  <option value="Europe/Berlin">Europe/Berlin</option>
                  <option value="Asia/Tokyo">Asia/Tokyo</option>
                  <option value="Asia/Shanghai">Asia/Shanghai</option>
                  <option value="Australia/Sydney">Australia/Sydney</option>
                  <option value="UTC">UTC</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="save-status" id="save-status">Settings saved</div>
  </main>

  <script src="./shared.js"></script>
  <script>
    // Load and save settings
    async function loadSettings() {
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          document.getElementById('turn-on-transition').value = config.turn_on_transition ?? 3;
          document.getElementById('turn-off-transition').value = config.turn_off_transition ?? 3;
          document.getElementById('two-step-delay').value = config.two_step_delay ?? 3;
          document.getElementById('multi-click-enabled').checked = config.multi_click_enabled ?? true;
          document.getElementById('multi-click-speed').value = config.multi_click_speed ?? 10;
          document.getElementById('long-press-repeat-interval').value = config.long_press_repeat_interval ?? 3;
          document.getElementById('reach-learn-mode').checked = config.reach_learn_mode ?? true;
          document.getElementById('circadian-refresh').value = config.circadian_refresh ?? 30;
          document.getElementById('home-refresh-interval').value = config.home_refresh_interval ?? 10;
          document.getElementById('log-periodic').checked = config.log_periodic ?? false;
          document.getElementById('motion-warning-time').value = config.motion_warning_time ?? 0;
          document.getElementById('motion-warning-blink-threshold').value = config.motion_warning_blink_threshold ?? 15;
          document.getElementById('freeze-off-rise').value = config.freeze_off_rise ?? 10;
          document.getElementById('limit-warning-speed').value = config.limit_warning_speed ?? 3;
          document.getElementById('limit-bounce-max-percent').value = config.limit_bounce_max_percent ?? 30;
          document.getElementById('limit-bounce-min-percent').value = config.limit_bounce_min_percent ?? 10;
          document.getElementById('reach-dip-percent').value = config.reach_dip_percent ?? 50;
          document.getElementById('boost-default').value = config.boost_default ?? 30;
          updateMultiClickState();
          updateLocationSection(config);
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function saveSettings() {
      const settings = {
        turn_on_transition: parseFloat(document.getElementById('turn-on-transition').value) || 3,
        turn_off_transition: parseFloat(document.getElementById('turn-off-transition').value) || 3,
        two_step_delay: parseFloat(document.getElementById('two-step-delay').value) || 3,
        multi_click_enabled: document.getElementById('multi-click-enabled').checked,
        multi_click_speed: parseFloat(document.getElementById('multi-click-speed').value) || 10,
        long_press_repeat_interval: parseFloat(document.getElementById('long-press-repeat-interval').value) || 3,
        reach_learn_mode: document.getElementById('reach-learn-mode').checked,
        circadian_refresh: parseInt(document.getElementById('circadian-refresh').value) || 30,
        home_refresh_interval: parseInt(document.getElementById('home-refresh-interval').value) || 10,
        log_periodic: document.getElementById('log-periodic').checked,
        motion_warning_time: parseInt(document.getElementById('motion-warning-time').value) || 0,
        motion_warning_blink_threshold: parseInt(document.getElementById('motion-warning-blink-threshold').value) || 15,
        freeze_off_rise: parseFloat(document.getElementById('freeze-off-rise').value) || 10,
        limit_warning_speed: parseFloat(document.getElementById('limit-warning-speed').value) || 3,
        limit_bounce_max_percent: parseInt(document.getElementById('limit-bounce-max-percent').value) || 30,
        limit_bounce_min_percent: parseInt(document.getElementById('limit-bounce-min-percent').value) || 10,
        reach_dip_percent: parseInt(document.getElementById('reach-dip-percent').value) || 50,
        boost_default: parseInt(document.getElementById('boost-default').value) || 30
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving settings:', err);
      }
    }

    function updateMultiClickState() {
      const enabled = document.getElementById('multi-click-enabled').checked;
      const speedGroup = document.getElementById('multi-click-speed-group');
      const speedInput = document.getElementById('multi-click-speed');

      if (enabled) {
        speedGroup.style.opacity = '1';
        speedInput.disabled = false;
      } else {
        speedGroup.style.opacity = '0.4';
        speedInput.disabled = true;
      }
    }

    async function syncDevices() {
      const btn = document.getElementById('sync-devices-btn');
      const status = document.getElementById('sync-status');
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      status.textContent = '';
      try {
        const response = await fetch('./api/sync-devices', { method: 'POST' });
        const result = await response.json();
        if (response.ok) {
          status.textContent = 'Sync complete';
          status.style.color = '#4caf50';
        } else {
          status.textContent = result.error || 'Sync failed';
          status.style.color = '#f44336';
        }
      } catch (err) {
        status.textContent = 'Sync failed';
        status.style.color = '#f44336';
        console.error('Error syncing devices:', err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync now';
        setTimeout(() => { status.textContent = ''; }, 5000);
      }
    }

    function showSaveStatus() {
      const status = document.getElementById('save-status');
      status.classList.add('visible');
      setTimeout(() => status.classList.remove('visible'), 2000);
    }

    // Auto-save on blur for number inputs (avoids decrement bug on focus)
    document.getElementById('turn-on-transition').addEventListener('blur', saveSettings);
    document.getElementById('turn-off-transition').addEventListener('blur', saveSettings);
    document.getElementById('two-step-delay').addEventListener('blur', saveSettings);
    document.getElementById('multi-click-enabled').addEventListener('change', () => {
      updateMultiClickState();
      saveSettings();
    });
    document.getElementById('multi-click-speed').addEventListener('blur', saveSettings);
    document.getElementById('long-press-repeat-interval').addEventListener('blur', saveSettings);
    document.getElementById('reach-learn-mode').addEventListener('change', saveSettings);
    document.getElementById('circadian-refresh').addEventListener('blur', saveSettings);
    document.getElementById('home-refresh-interval').addEventListener('blur', saveSettings);
    document.getElementById('log-periodic').addEventListener('change', saveSettings);
    document.getElementById('motion-warning-time').addEventListener('blur', saveSettings);
    document.getElementById('motion-warning-blink-threshold').addEventListener('blur', saveSettings);
    document.getElementById('freeze-off-rise').addEventListener('blur', saveSettings);
    document.getElementById('limit-warning-speed').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-max-percent').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-min-percent').addEventListener('blur', saveSettings);
    document.getElementById('reach-dip-percent').addEventListener('blur', saveSettings);
    document.getElementById('boost-default').addEventListener('blur', saveSettings);

    // Location functions
    function updateLocationSection(config) {
      const useHA = config.use_ha_location !== false;
      document.getElementById('use-ha-location').checked = useHA;
      document.getElementById('latitude').value = config.latitude || '';
      document.getElementById('longitude').value = config.longitude || '';
      document.getElementById('timezone').value = config.timezone || 'US/Eastern';
      updateLocationInputsState(useHA);
    }

    function updateLocationInputsState(useHA) {
      const fields = document.getElementById('location-fields');
      const inputs = fields.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = useHA);
      if (useHA) {
        fields.classList.add('disabled');
      } else {
        fields.classList.remove('disabled');
      }
    }

    async function saveLocationSettings() {
      const settings = {
        use_ha_location: document.getElementById('use-ha-location').checked,
        latitude: parseFloat(document.getElementById('latitude').value) || null,
        longitude: parseFloat(document.getElementById('longitude').value) || null,
        timezone: document.getElementById('timezone').value
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving location:', err);
      }
    }

    document.getElementById('use-ha-location').addEventListener('change', (e) => {
      updateLocationInputsState(e.target.checked);
      saveLocationSettings();
    });

    ['latitude', 'longitude', 'timezone'].forEach(id => {
      document.getElementById(id).addEventListener('change', saveLocationSettings);
    });

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadSettings);
  </script>
</body>
</html>
