<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circadian Light - Settings</title>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --card: #1a1a1a;
      --accent: #feac60;
      --accent-hover: #ffc078;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --line: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-right: 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand.active {
      color: var(--accent);
    }

    .nav-logo {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .nav-link {
      padding: 8px 10px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }


    /* Nav overflow menu */
    .nav-more { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: none; flex-shrink: 0; letter-spacing: 2px; line-height: 1; }
    .nav-more:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow { display: none; position: absolute; top: 100%; right: 12px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 4px 0; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 200; }
    .nav-overflow.open { display: block; }
    .nav-overflow-item { display: block; padding: 10px 16px; color: var(--muted); text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
    .nav-overflow-item:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow-item.active { color: var(--accent); }

    /* Main Content */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Settings Sections */
    .settings-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section-header {
      background: var(--panel);
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-content {
      padding: 20px;
    }

    .section-content.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Form Controls */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-label {
      min-width: 160px;
      font-size: 0.9rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-control {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-input {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      width: 200px;
    }

    .form-input:focus {
      outline: 2px solid dodgerblue;
    }

    /* Hide number input spinners to prevent accidental value changes on click */
    .form-input[type="number"]::-webkit-inner-spin-button,
    .form-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .form-input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--muted2);
      margin-left: 12px;
    }

    /* Info Icon */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 10px;
      font-style: italic;
      color: rgba(255,255,255,0.5);
      cursor: help;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      color: rgba(255,255,255,0.8);
      border-color: rgba(255,255,255,0.5);
    }

    .info-tooltip {
      display: none;
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      width: 280px;
      font-size: 0.8rem;
      font-style: normal;
      color: var(--muted);
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .info-icon:hover .info-tooltip {
      display: block;
    }

    /* Save Status */
    .save-status {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
    }

    .save-status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Checkbox */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .form-row.disabled {
      opacity: 0.5;
    }

    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Location */
    .location-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px 20px;
    }

    .location-row {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .location-fields {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .location-fields.disabled {
      opacity: 0.4;
    }

    .location-field {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--muted2);
    }

    .location-input {
      width: 80px;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .location-input:focus {
      outline: 2px solid dodgerblue;
    }

    .location-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .location-select {
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      min-width: 100px;
    }

    .location-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Filter presets */
    .filter-preset-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .filter-preset-name {
      min-width: 100px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .filter-preset-name input {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
      padding: 4px 6px;
      border-radius: 4px;
      width: 100px;
    }

    .filter-preset-name input:focus {
      border-color: var(--line);
      outline: none;
      background: var(--card);
    }

    .filter-slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .filter-slider-group label {
      font-size: 0.75rem;
      color: var(--muted2);
      min-width: 50px;
      text-align: right;
    }

    .filter-slider-group input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
      min-width: 80px;
    }

    .filter-slider-value {
      font-size: 0.8rem;
      color: var(--muted);
      min-width: 35px;
      text-align: right;
    }

    .filter-preset-delete {
      background: none;
      border: none;
      color: var(--muted2);
      cursor: pointer;
      padding: 4px;
      font-size: 1.1rem;
      line-height: 1;
      border-radius: 4px;
    }

    .filter-preset-delete:hover {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="./" class="nav-brand">
      <svg class="nav-logo" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#555"/>
        <path d="M20 1 A19 19 0 0 1 20 39 Q20 28 8 20 Q20 12 20 1" fill="#ccc"/>
        <circle cx="20" cy="12" r="5" fill="#fff"/>
        <line x1="20" y1="3" x2="20" y2="5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="27" y1="6" x2="25.5" y2="7.5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="29" y1="12" x2="27" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <path d="M16 30 A6 6 0 1 1 24 30 A4.5 4.5 0 1 0 16 30" fill="#fff"/>
      </svg>
      Home
    </a>
    <div class="nav-links">
      <a href="./switches" class="nav-link">Controls</a>
      <a href="./tune" class="nav-link">Tune</a>
      <a href="./moments" class="nav-link">Magic</a>
      <a href="./settings" class="nav-link active">Settings</a>
    </div>
    <button class="nav-more" aria-label="More pages">&middot;&middot;&middot;</button>
    <div class="nav-overflow"></div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>

    <!-- General Section -->
    <div class="settings-section">
      <div class="section-header">General</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Home name
            <span class="info-icon">i<span class="info-tooltip">A display name for your home, shown as a heading on the home page.</span></span>
          </label>
          <div class="form-control">
            <input type="text" class="form-input" id="home-name" placeholder="Your home" style="width: 200px;">
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Recover from power failure
            <span class="info-icon">i<span class="info-tooltip">Controls what lights do after a power outage. 'Bright' turns lights on at full brightness. 'Last state' restores whatever state lights were in before the outage. Applied to all lights at add-on startup.</span></span>
          </label>
          <div class="form-control">
            <select class="form-input" id="power-recovery" style="width: 200px;">
              <option value="bright">Bright</option>
              <option value="last_state">Last state</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div class="settings-section">
      <div class="section-header">Controls</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Multi-click
            <span class="info-icon">i<span class="info-tooltip">For switches controlled by a hub that doesn't support double-clicks, triple-clicks, etc. (e.g. the Philips Hue Hub), enabling turns on Circadian Light detection of multi-clicks. Single-click actions will be delayed by the multi-click speed while waiting for additional clicks.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="multi-click-enabled">
            </label>
            <span id="multi-click-speed-group" style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
              <span class="form-hint" style="margin-left: 0;">Speed</span>
              <input type="number" class="form-input" id="multi-click-speed" min="1" max="100" step="0.1" value="10" style="width: 60px;">
              <span class="form-hint">tenths of a second</span>
            </span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Long-press repeat interval
            <span class="info-icon">i<span class="info-tooltip">How fast brightness changes when holding up/down buttons on a switch. Lower values = faster ramping.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="long-press-repeat-interval" min="1" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Step increments
            <span class="info-icon">i<span class="info-tooltip">Number of steps between minimum and maximum when pressing up/down buttons on a switch. Fewer steps = bigger jumps. Applies to Circadian, Bright, and Color controls across all zones.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="max-dim-steps" min="1" max="50" step="1" value="10" style="width: 60px;">
            <span class="form-hint">steps</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Cues Section -->
    <div class="settings-section">
      <div class="section-header">Feedback Cues</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Power speed
            <span class="info-icon">i<span class="info-tooltip">How fast lights smoothly turn on or off when Circadian Light controls them.</span></span>
          </label>
          <div class="form-control">
            <span class="form-hint" style="margin-left: 0;">on</span>
            <input type="number" class="form-input" id="turn-on-transition" min="0" max="100" step="0.1" value="3" style="width: 60px;">
            <span class="form-hint">off</span>
            <input type="number" class="form-input" id="turn-off-transition" min="0" max="100" step="0.1" value="3" style="width: 60px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Two-step delay
            <span class="info-icon">i<span class="info-tooltip">When turning on lights, a two-step process sets color at 1% then transitions to target brightness. This delay between steps prevents some ZigBee lights from dropping the second command. Increase if lights stay dim after turn-on.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="two-step-delay" min="0" max="20" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Reach adjustment learn mode
            <span class="info-icon">i<span class="info-tooltip">When enabled, all lights in the reach areas fade out and back so you can see which areas are included. When disabled, only a single indicator light flashes (1x/2x/3x for each reach level). Configure the indicator light per-switch in the Controls page.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="reach-learn-mode" checked>
            </label>
            <span class="form-hint" style="margin-left: 12px;">Flash all area lights to show reach contents</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Motion warning time
            <span class="info-icon">i<span class="info-tooltip">How long before the motion timer expires to trigger a warning dim. Set to 0 to disable motion warnings. The warning dims lights to alert you before they turn off.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-time" min="0" max="120" step="5" value="0" style="width: 80px;">
            <span class="form-hint">seconds before off (0 = disabled)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning blink threshold
            <span class="info-icon">i<span class="info-tooltip">At low brightness levels, a simple dim may not be noticeable. Below this threshold, the warning will briefly blink off (0% for 300ms) before dimming to ensure you notice. Formula: above threshold dims to 50% of current; below threshold blinks then dims to 3%.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-blink-threshold" min="5" max="50" step="1" value="15" style="width: 80px;">
            <span class="form-hint">% brightness</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Freeze off rise speed
            <span class="info-icon">i<span class="info-tooltip">When unfreezing, lights rise back to circadian values over this amount of time. A slower rise gives a gentle visual confirmation that the area has been unfrozen.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="freeze-off-rise" min="0" max="100" step="0.1" value="10" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit warning speed
            <span class="info-icon">i<span class="info-tooltip">When stepping up/down hits the brightness or color limit, lights bounce to indicate the limit. This controls how fast the bounce animation plays.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-warning-speed" min="0" max="100" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (max)
            <span class="info-icon">i<span class="info-tooltip">How much to dip when hitting the upper limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-max-percent" min="5" max="50" step="1" value="30" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit bounce (min)
            <span class="info-icon">i<span class="info-tooltip">How much to flash when hitting the lower limit. Expressed as a percentage of the brightness or color range.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-bounce-min-percent" min="5" max="50" step="1" value="10" style="width: 80px;">
            <span class="form-hint">% of range</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Reach feedback dip
            <span class="info-icon">i<span class="info-tooltip">How much lights dip during reach change feedback. Expressed as a percentage of current brightness.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="reach-dip-percent" min="10" max="80" step="5" value="50" style="width: 80px;">
            <span class="form-hint">% of current</span>
          </div>
        </div>
      </div>
    </div>


    <!-- Outdoor Brightness Section -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-header-left">
          Outdoor Brightness
          <span class="info-icon">i<span class="info-tooltip">Controls how the system estimates outdoor light levels. Uses the highest-priority source available: manual override, lux sensor, weather entity, or sun angle estimate.</span></span>
        </div>
      </div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Source
            <span class="info-icon">i<span class="info-tooltip">Where outdoor brightness comes from. Lux sensor uses a hardware sensor. HA weather uses cloud coverage from an auto-detected weather entity. Sun angle uses a clear-sky estimate only.</span></span>
          </label>
          <div class="form-control" style="display: flex; gap: 12px; align-items: center;">
            <select class="form-input" id="outdoor-brightness-source" style="width: 180px;">
              <option value="lux">Lux sensor</option>
              <option value="weather">HA weather</option>
              <option value="angle">Sun angle</option>
            </select>
            <span id="outdoor-status-badge" style="display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.82rem; font-weight: 500; background: rgba(255,255,255,0.08); color: var(--muted);">---</span>
            <span id="outdoor-status-detail" class="form-hint"></span>
          </div>
        </div>
        <div id="lux-settings-group">
          <div class="form-row">
            <label class="form-label">
              Sensor entity
              <span class="info-icon">i<span class="info-tooltip">An outdoor illuminance sensor (e.g. sensor.outdoor_illuminance). Falls back to weather then angle if unavailable.</span></span>
            </label>
            <div class="form-control">
              <select class="form-input" id="outdoor-lux-sensor" style="width: 280px;">
                <option value="">None (disabled)</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <label class="form-label">
              Smoothing interval
              <span class="info-icon">i<span class="info-tooltip">EMA (exponential moving average) time constant in seconds. Higher values smooth out rapid lux changes (clouds passing). Set to 0 for no smoothing (raw values).</span></span>
            </label>
            <div class="form-control">
              <input type="number" class="form-input" id="lux-smoothing-interval" min="0" max="3600" step="30" value="300" style="width: 80px;">
              <span class="form-hint">s</span>
            </div>
          </div>
          <div class="form-row">
            <label class="form-label">
              Learned ceiling
              <span class="info-icon">i<span class="info-tooltip">Bright-day lux baseline (85th percentile of daytime readings). Learned automatically from 90 days of sensor history. You can override with a manual value.</span></span>
            </label>
            <div class="form-control">
              <input type="number" class="form-input" id="lux-learned-ceiling" min="1" max="200000" step="100" placeholder="auto" style="width: 100px;">
              <span class="form-hint">lux</span>
            </div>
          </div>
          <div class="form-row">
            <label class="form-label">
              Learned floor
              <span class="info-icon">i<span class="info-tooltip">Dark-day lux baseline (5th percentile of daytime readings). Learned automatically from 90 days of sensor history. You can override with a manual value.</span></span>
            </label>
            <div class="form-control">
              <input type="number" class="form-input" id="lux-learned-floor" min="1" max="200000" step="10" placeholder="auto" style="width: 100px;">
              <span class="form-hint">lux</span>
            </div>
          </div>
        </div>
        <div class="form-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line);">
          <label class="form-label">
            Manual override
            <span class="info-icon">i<span class="info-tooltip">Temporarily override outdoor brightness estimation. Auto-reverts after the selected duration.</span></span>
          </label>
          <div class="form-control" style="display: flex; gap: 8px; align-items: center;">
            <select class="form-input" id="override-condition" style="width: 160px;">
              <option value="">Off</option>
              <option value="sunny">Sunny</option>
              <option value="partly_cloudy">Partly cloudy</option>
              <option value="cloudy">Cloudy</option>
              <option value="heavy_overcast">Heavy overcast</option>
            </select>
            <select class="form-input" id="override-duration" style="width: 100px;">
              <option value="30">30 min</option>
              <option value="60" selected>1 hour</option>
              <option value="120">2 hours</option>
              <option value="240">4 hours</option>
            </select>
            <button type="button" class="btn btn-sm" id="override-apply" style="display: none;">Apply</button>
            <button type="button" class="btn btn-sm" id="override-clear" style="display: none; background: var(--danger); color: #fff;">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CT Brightness Compensation Section -->
    <div class="settings-section">
      <div class="section-header">
        <div class="section-header-left">
          CT Brightness Compensation
          <span class="info-icon">i<span class="info-tooltip">Compensates for brightness loss when Hue bulbs transition from efficient warm-white LEDs to less efficient RGB LEDs at very warm color temperatures. The "handover zone" is where this transition occurs.</span></span>
        </div>
        <label class="checkbox-label" style="font-weight: normal;">
          <input type="checkbox" id="ct-comp-enabled">
          <span style="font-size: 0.85rem;">Enabled</span>
        </label>
      </div>
      <div class="section-content" id="ct-comp-content">
        <div class="form-row">
          <label class="form-label">
            Handover begin
            <span class="info-icon">i<span class="info-tooltip">The warmer (lower) end of the handover zone where RGB LEDs take over completely. Below this temperature, compensation is capped at the max factor.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-begin" min="500" max="2500" step="50" value="1650" style="width: 100px;">
            <span class="form-hint">K</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Handover end
            <span class="info-icon">i<span class="info-tooltip">The cooler (higher) end of the handover zone where warm-white LEDs are still efficient. Above this temperature, no compensation is applied.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-end" min="1500" max="3500" step="50" value="2250" style="width: 100px;">
            <span class="form-hint">K</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Max compensation
            <span class="info-icon">i<span class="info-tooltip">The brightness multiplier applied at and below the handover begin temperature. 1.4 means brightness is boosted by 40% to counteract the perceived dimming.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="ct-comp-factor" min="1.0" max="2.0" step="0.05" value="1.4" style="width: 100px;">
            <span class="form-hint">Ã— (1.0 = none, 1.4 = 40% boost)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Light Filters Section -->
    <div class="settings-section">
      <div class="section-header">Light Filters</div>
      <div class="section-content">
        <div id="filter-presets-container">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <label class="form-label" style="min-width: auto;">
              Filter presets
              <span class="info-icon">i<span class="info-tooltip">Define brightness curve modifiers for different light roles. "at bright" is the multiplier when the circadian curve is at maximum brightness. "at dim" is the multiplier at minimum. Values interpolate linearly between. 100% = no change, 0% = off, 200% = double (capped at 100% final).</span></span>
            </label>
            <button type="button" class="btn" id="add-preset-btn" onclick="addFilterPreset()" style="padding: 4px 12px; cursor: pointer; font-size: 0.85rem;">+ Add preset</button>
          </div>
          <div id="filter-presets-list"></div>
        </div>
      </div>
    </div>

    <!-- Location Section -->
    <div class="settings-section">
      <div class="section-header">Location</div>
      <div class="section-content">
        <div class="location-section" id="location-section">
          <div class="location-row">
            <label class="checkbox-label">
              <input type="checkbox" id="use-ha-location" checked>
              <span>Use Home Assistant location</span>
            </label>
            <div class="location-fields" id="location-fields">
              <div class="location-field">
                <span class="field-label">Lat</span>
                <input type="number" class="location-input" id="latitude" step="0.0001" placeholder="40.71" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">Long</span>
                <input type="number" class="location-input" id="longitude" step="0.0001" placeholder="-74.00" disabled>
              </div>
              <div class="location-field">
                <span class="field-label">TZ</span>
                <select class="location-select" id="timezone" disabled>
                  <option value="US/Eastern">US/Eastern</option>
                  <option value="US/Central">US/Central</option>
                  <option value="US/Mountain">US/Mountain</option>
                  <option value="US/Pacific">US/Pacific</option>
                  <option value="US/Alaska">US/Alaska</option>
                  <option value="US/Hawaii">US/Hawaii</option>
                  <option value="Europe/London">Europe/London</option>
                  <option value="Europe/Paris">Europe/Paris</option>
                  <option value="Europe/Berlin">Europe/Berlin</option>
                  <option value="Asia/Tokyo">Asia/Tokyo</option>
                  <option value="Asia/Shanghai">Asia/Shanghai</option>
                  <option value="Australia/Sydney">Australia/Sydney</option>
                  <option value="UTC">UTC</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- App Section -->
    <div class="settings-section">
      <div class="section-header">App</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Confirm zone pushes
            <span class="info-icon">i<span class="info-tooltip">When enabled, shows a confirmation dialog before pushing light settings to an entire Rhythm Zone (Full Send, GloDown, Zone Power Off). When disabled, these actions execute immediately.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="confirm-zone-pushes">
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Refresh Section -->
    <div class="settings-section">
      <div class="section-header">Refresh</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Circadian refresh
            <span class="info-icon">i<span class="info-tooltip">How often Circadian Light updates lights to match the current sun position. Timers (motion, boost) are checked every second regardless of this setting. Lower values give smoother light transitions but increase Home Assistant API calls.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="circadian-refresh" min="5" max="120" step="5" value="30" style="width: 80px;">
            <span class="form-hint">seconds (5-120)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Periodic transition speed
            <span class="info-icon">i<span class="info-tooltip">How smoothly lights transition during periodic circadian updates. Day speed applies when the sun is up, night speed when the sun is down. Higher values = slower, smoother transitions.</span></span>
          </label>
          <div class="form-control">
            <span class="form-hint" style="margin-left: 0;">day</span>
            <input type="number" class="form-input" id="periodic-transition-day" min="0" max="120" step="1" style="width: 60px;">
            <span class="form-hint">night</span>
            <input type="number" class="form-input" id="periodic-transition-night" min="0" max="120" step="1" value="1" style="width: 60px;">
            <span class="form-hint">seconds</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Home page refresh
            <span class="info-icon">i<span class="info-tooltip">How often the home page area cards refresh to show current brightness, color temperature, and on/off state. Lower values show changes faster but increase browser network activity. The area modal always refreshes every 1 second regardless of this setting.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="home-refresh-interval" min="2" max="60" step="1" value="10" style="width: 80px;">
            <span class="form-hint">seconds (2-60)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Advanced logging
            <span class="info-icon">i<span class="info-tooltip">When enabled, logs detailed info about every periodic light update cycle (per-area brightness/color values, group breakdowns, off enforcement). Useful for debugging but very verbose. Auto-disables after the selected duration.</span></span>
          </label>
          <div class="form-control">
            <select class="form-input" id="advanced-logging" style="width: 140px;">
              <option value="">Off</option>
              <option value="1h">1 hour</option>
              <option value="4h">4 hours</option>
              <option value="1d">1 day</option>
              <option value="1w">1 week</option>
              <option value="1m">1 month</option>
              <option value="forever">Forever</option>
            </select>
            <span class="form-hint" id="advanced-logging-remaining"></span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 10px;">
          <label class="form-label">
            Sync devices
            <span class="info-icon">i<span class="info-tooltip">Re-scans Home Assistant for new or moved lights, areas, and ZHA devices. Only needed after adding or moving hardware. This does not run automatically.</span></span>
          </label>
          <div class="form-control">
            <button type="button" class="btn" id="sync-devices-btn" onclick="syncDevices()" style="padding: 6px 16px; cursor: pointer;">Sync now</button>
            <span class="form-hint" id="sync-status"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="save-status" id="save-status">Settings saved</div>
  </main>

  <script src="./shared.js"></script>
  <script>
    let advancedLoggingUntil = null;

    function updateLoggingRemaining() {
      const el = document.getElementById('advanced-logging-remaining');
      if (!advancedLoggingUntil || advancedLoggingUntil === 'forever') {
        el.textContent = advancedLoggingUntil === 'forever' ? 'always on' : '';
        return;
      }
      const remaining = new Date(advancedLoggingUntil) - Date.now();
      if (remaining <= 0) {
        el.textContent = 'expired';
        document.getElementById('advanced-logging').value = '';
        return;
      }
      const mins = Math.floor(remaining / 60000);
      const hours = Math.floor(mins / 60);
      const days = Math.floor(hours / 24);
      if (days > 0) el.textContent = days + 'd ' + (hours % 24) + 'h left';
      else if (hours > 0) el.textContent = hours + 'h ' + (mins % 60) + 'm left';
      else el.textContent = mins + 'm left';
    }
    setInterval(updateLoggingRemaining, 60000);

    // Load and save settings
    async function loadSettings() {
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          document.getElementById('home-name').value = config.home_name ?? 'Your home';
          document.getElementById('power-recovery').value = config.power_recovery ?? 'last_state';
          document.getElementById('turn-on-transition').value = config.turn_on_transition ?? 3;
          document.getElementById('turn-off-transition').value = config.turn_off_transition ?? 3;
          document.getElementById('two-step-delay').value = config.two_step_delay ?? 3;
          document.getElementById('multi-click-enabled').checked = config.multi_click_enabled ?? true;
          document.getElementById('multi-click-speed').value = config.multi_click_speed ?? 10;
          document.getElementById('long-press-repeat-interval').value = config.long_press_repeat_interval ?? 3;
          document.getElementById('max-dim-steps').value = config.max_dim_steps ?? 10;
          document.getElementById('reach-learn-mode').checked = config.reach_learn_mode ?? true;
          document.getElementById('confirm-zone-pushes').checked = config.confirm_zone_pushes ?? false;
          document.getElementById('circadian-refresh').value = config.circadian_refresh ?? 30;
          const refreshDefault = config.circadian_refresh ?? 30;
          document.getElementById('periodic-transition-day').value = config.periodic_transition_day ?? refreshDefault;
          document.getElementById('periodic-transition-night').value = config.periodic_transition_night ?? 1;
          document.getElementById('home-refresh-interval').value = config.home_refresh_interval ?? 10;
          // Advanced logging
          advancedLoggingUntil = config.advanced_logging_until || null;
          const loggingSelect = document.getElementById('advanced-logging');
          if (!advancedLoggingUntil) {
            loggingSelect.value = '';
          } else if (advancedLoggingUntil === 'forever') {
            loggingSelect.value = 'forever';
          } else {
            const remaining = new Date(advancedLoggingUntil) - Date.now();
            if (remaining <= 0) {
              loggingSelect.value = '';
            } else {
              const hours = remaining / 3600000;
              if (hours <= 1.5) loggingSelect.value = '1h';
              else if (hours <= 6) loggingSelect.value = '4h';
              else if (hours <= 36) loggingSelect.value = '1d';
              else if (hours <= 10 * 24) loggingSelect.value = '1w';
              else loggingSelect.value = '1m';
            }
          }
          updateLoggingRemaining();
          document.getElementById('motion-warning-time').value = config.motion_warning_time ?? 0;
          document.getElementById('motion-warning-blink-threshold').value = config.motion_warning_blink_threshold ?? 15;
          document.getElementById('freeze-off-rise').value = config.freeze_off_rise ?? 10;
          document.getElementById('limit-warning-speed').value = config.limit_warning_speed ?? 3;
          document.getElementById('limit-bounce-max-percent').value = config.limit_bounce_max_percent ?? 30;
          document.getElementById('limit-bounce-min-percent').value = config.limit_bounce_min_percent ?? 10;
          document.getElementById('reach-dip-percent').value = config.reach_dip_percent ?? 50;
          // Outdoor brightness source selector
          const sourceSelect = document.getElementById('outdoor-brightness-source');
          const savedSource = config.outdoor_brightness_source ?? (config.outdoor_lux_sensor ? 'lux' : 'weather');
          sourceSelect.value = savedSource;
          // Populate lux sensor dropdown
          const luxSelect = document.getElementById('outdoor-lux-sensor');
          const savedSensor = config.outdoor_lux_sensor ?? '';
          try {
            const sensorsRes = await fetch('./api/sensors?device_class=illuminance');
            if (sensorsRes.ok) {
              const sensorsData = await sensorsRes.json();
              luxSelect.innerHTML = '<option value="">None (disabled)</option>';
              for (const s of sensorsData.sensors || []) {
                const opt = document.createElement('option');
                opt.value = s.entity_id;
                opt.textContent = s.name + (s.state ? ' (' + s.state + ' ' + (s.unit || '') + ')' : '');
                luxSelect.appendChild(opt);
              }
            }
          } catch (e) { console.warn('Could not load illuminance sensors:', e); }
          if (savedSensor && !luxSelect.querySelector('option[value="' + CSS.escape(savedSensor) + '"]')) {
            const opt = document.createElement('option');
            opt.value = savedSensor;
            opt.textContent = savedSensor + ' (not found)';
            luxSelect.appendChild(opt);
          }
          luxSelect.value = savedSensor;
          document.getElementById('lux-smoothing-interval').value = config.lux_smoothing_interval ?? 300;
          document.getElementById('lux-learned-ceiling').value = config.lux_learned_ceiling ?? '';
          document.getElementById('lux-learned-floor').value = config.lux_learned_floor ?? '';
          updateOutdoorSourceState();
          // Load outdoor status
          refreshOutdoorStatus();
          document.getElementById('ct-comp-enabled').checked = config.ct_comp_enabled ?? false;
          document.getElementById('ct-comp-begin').value = config.ct_comp_begin ?? 1650;
          document.getElementById('ct-comp-end').value = config.ct_comp_end ?? 2250;
          document.getElementById('ct-comp-factor').value = config.ct_comp_factor ?? 1.4;
          updateMultiClickState();
          updateCtCompState();
          updateLocationSection(config);
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function saveSettings() {
      const settings = {
        home_name: document.getElementById('home-name').value.trim(),
        power_recovery: document.getElementById('power-recovery').value,
        turn_on_transition: parseFloat(document.getElementById('turn-on-transition').value) || 3,
        turn_off_transition: parseFloat(document.getElementById('turn-off-transition').value) || 3,
        two_step_delay: parseFloat(document.getElementById('two-step-delay').value) || 3,
        multi_click_enabled: document.getElementById('multi-click-enabled').checked,
        multi_click_speed: parseFloat(document.getElementById('multi-click-speed').value) || 10,
        long_press_repeat_interval: parseFloat(document.getElementById('long-press-repeat-interval').value) || 3,
        max_dim_steps: parseInt(document.getElementById('max-dim-steps').value) || 10,
        reach_learn_mode: document.getElementById('reach-learn-mode').checked,
        confirm_zone_pushes: document.getElementById('confirm-zone-pushes').checked,
        circadian_refresh: parseInt(document.getElementById('circadian-refresh').value) || 30,
        periodic_transition_day: parseInt(document.getElementById('periodic-transition-day').value) || (parseInt(document.getElementById('circadian-refresh').value) || 30),
        periodic_transition_night: parseInt(document.getElementById('periodic-transition-night').value) || 1,
        home_refresh_interval: parseInt(document.getElementById('home-refresh-interval').value) || 10,
        motion_warning_time: parseInt(document.getElementById('motion-warning-time').value) || 0,
        motion_warning_blink_threshold: parseInt(document.getElementById('motion-warning-blink-threshold').value) || 15,
        freeze_off_rise: parseFloat(document.getElementById('freeze-off-rise').value) || 10,
        limit_warning_speed: parseFloat(document.getElementById('limit-warning-speed').value) || 3,
        limit_bounce_max_percent: parseInt(document.getElementById('limit-bounce-max-percent').value) || 30,
        limit_bounce_min_percent: parseInt(document.getElementById('limit-bounce-min-percent').value) || 10,
        reach_dip_percent: parseInt(document.getElementById('reach-dip-percent').value) || 50,
        outdoor_brightness_source: document.getElementById('outdoor-brightness-source').value,
        outdoor_lux_sensor: document.getElementById('outdoor-lux-sensor').value.trim() || null,
        lux_smoothing_interval: parseInt(document.getElementById('lux-smoothing-interval').value || '300'),
        lux_learned_ceiling: parseFloat(document.getElementById('lux-learned-ceiling').value) || null,
        lux_learned_floor: parseFloat(document.getElementById('lux-learned-floor').value) || null,
        ct_comp_enabled: document.getElementById('ct-comp-enabled').checked,
        ct_comp_begin: parseInt(document.getElementById('ct-comp-begin').value) || 1650,
        ct_comp_end: parseInt(document.getElementById('ct-comp-end').value) || 2250,
        ct_comp_factor: parseFloat(document.getElementById('ct-comp-factor').value) || 1.4
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving settings:', err);
      }
    }

    function updateMultiClickState() {
      const enabled = document.getElementById('multi-click-enabled').checked;
      const speedGroup = document.getElementById('multi-click-speed-group');
      const speedInput = document.getElementById('multi-click-speed');

      if (enabled) {
        speedGroup.style.opacity = '1';
        speedInput.disabled = false;
      } else {
        speedGroup.style.opacity = '0.4';
        speedInput.disabled = true;
      }
    }

    function updateCtCompState() {
      const enabled = document.getElementById('ct-comp-enabled').checked;
      const content = document.getElementById('ct-comp-content');
      if (enabled) {
        content.classList.remove('disabled');
      } else {
        content.classList.add('disabled');
      }
    }

    async function syncDevices() {
      const btn = document.getElementById('sync-devices-btn');
      const status = document.getElementById('sync-status');
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      status.textContent = '';
      try {
        const response = await fetch('./api/sync-devices', { method: 'POST' });
        const result = await response.json();
        if (response.ok) {
          status.textContent = 'Sync complete';
          status.style.color = '#4caf50';
        } else {
          status.textContent = result.error || 'Sync failed';
          status.style.color = '#f44336';
        }
      } catch (err) {
        status.textContent = 'Sync failed';
        status.style.color = '#f44336';
        console.error('Error syncing devices:', err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync now';
        setTimeout(() => { status.textContent = ''; }, 5000);
      }
    }

    function showSaveStatus() {
      const status = document.getElementById('save-status');
      status.classList.add('visible');
      setTimeout(() => status.classList.remove('visible'), 2000);
    }

    // Outdoor brightness source visibility
    function updateOutdoorSourceState() {
      const source = document.getElementById('outdoor-brightness-source').value;
      document.getElementById('lux-settings-group').style.display = source === 'lux' ? '' : 'none';
    }

    // Outdoor brightness override + status
    async function refreshOutdoorStatus() {
      try {
        const res = await fetch('./api/outdoor-status');
        if (!res.ok) return;
        const data = await res.json();
        const badge = document.getElementById('outdoor-status-badge');
        const detail = document.getElementById('outdoor-status-detail');
        const pct = Math.round((data.outdoor_normalized ?? 0) * 100);
        const sourceLabels = { override: 'Override', lux: 'Lux sensor', weather: 'Weather', angle: 'Sun angle', none: 'None' };
        const sourceColors = { override: 'var(--warning)', lux: 'var(--success)', weather: '#60a5fa', angle: 'var(--muted)', none: 'var(--danger)' };
        const src = data.source || 'none';
        badge.textContent = (sourceLabels[src] || src) + ': ' + pct + '%';
        badge.style.background = sourceColors[src] || 'rgba(255,255,255,0.08)';
        badge.style.color = '#000';
        let detailText = '';
        if (data.override) {
          const cond = data.override.condition.replace('_', ' ');
          detailText = cond.charAt(0).toUpperCase() + cond.slice(1) + ' (' + data.override.expires_in_minutes + ' min left)';
        } else if (src === 'weather' && data.weather_cloud_cover != null) {
          detailText = 'Cloud cover: ' + Math.round(data.weather_cloud_cover) + '%';
        } else if (src === 'lux' && data.lux_smoothed != null) {
          detailText = 'Smoothed: ' + Math.round(data.lux_smoothed) + ' lux';
        }
        detail.textContent = detailText;

        // Show/hide override buttons
        const applyBtn = document.getElementById('override-apply');
        const clearBtn = document.getElementById('override-clear');
        const condSelect = document.getElementById('override-condition');
        if (data.override) {
          condSelect.value = data.override.condition;
          applyBtn.style.display = 'none';
          clearBtn.style.display = '';
        } else {
          clearBtn.style.display = 'none';
          applyBtn.style.display = condSelect.value ? '' : 'none';
        }
      } catch (e) { console.warn('Could not load outdoor status:', e); }
    }

    document.getElementById('override-condition').addEventListener('change', function() {
      const applyBtn = document.getElementById('override-apply');
      const clearBtn = document.getElementById('override-clear');
      applyBtn.style.display = this.value ? '' : 'none';
      clearBtn.style.display = 'none';
    });

    document.getElementById('override-apply').addEventListener('click', async function() {
      const condition = document.getElementById('override-condition').value;
      const duration = parseInt(document.getElementById('override-duration').value) || 60;
      if (!condition) return;
      try {
        await fetch('./api/outdoor-override', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ condition, duration_minutes: duration })
        });
        refreshOutdoorStatus();
      } catch (e) { console.error('Error applying override:', e); }
    });

    document.getElementById('override-clear').addEventListener('click', async function() {
      try {
        await fetch('./api/outdoor-override', { method: 'DELETE' });
        document.getElementById('override-condition').value = '';
        refreshOutdoorStatus();
      } catch (e) { console.error('Error clearing override:', e); }
    });

    // Auto-save on blur for number inputs (avoids decrement bug on focus)
    document.getElementById('home-name').addEventListener('blur', saveSettings);
    document.getElementById('power-recovery').addEventListener('change', saveSettings);
    document.getElementById('turn-on-transition').addEventListener('blur', saveSettings);
    document.getElementById('turn-off-transition').addEventListener('blur', saveSettings);
    document.getElementById('two-step-delay').addEventListener('blur', saveSettings);
    document.getElementById('multi-click-enabled').addEventListener('change', () => {
      updateMultiClickState();
      saveSettings();
    });
    document.getElementById('multi-click-speed').addEventListener('blur', saveSettings);
    document.getElementById('long-press-repeat-interval').addEventListener('blur', saveSettings);
    document.getElementById('max-dim-steps').addEventListener('blur', saveSettings);
    document.getElementById('reach-learn-mode').addEventListener('change', saveSettings);
    document.getElementById('confirm-zone-pushes').addEventListener('change', saveSettings);
    document.getElementById('circadian-refresh').addEventListener('blur', saveSettings);
    document.getElementById('periodic-transition-day').addEventListener('blur', saveSettings);
    document.getElementById('periodic-transition-night').addEventListener('blur', saveSettings);
    document.getElementById('home-refresh-interval').addEventListener('blur', saveSettings);
    document.getElementById('advanced-logging').addEventListener('change', async function() {
      const val = this.value;
      let until = null;
      if (val === 'forever') {
        until = 'forever';
      } else if (val) {
        const durations = { '1h': 3600, '4h': 14400, '1d': 86400, '1w': 604800, '1m': 2592000 };
        const secs = durations[val] || 3600;
        until = new Date(Date.now() + secs * 1000).toISOString();
      }
      advancedLoggingUntil = until;
      updateLoggingRemaining();
      await fetch('./api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ advanced_logging_until: until })
      });
      showSaveStatus();
    });
    document.getElementById('motion-warning-time').addEventListener('blur', saveSettings);
    document.getElementById('motion-warning-blink-threshold').addEventListener('blur', saveSettings);
    document.getElementById('freeze-off-rise').addEventListener('blur', saveSettings);
    document.getElementById('limit-warning-speed').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-max-percent').addEventListener('blur', saveSettings);
    document.getElementById('limit-bounce-min-percent').addEventListener('blur', saveSettings);
    document.getElementById('reach-dip-percent').addEventListener('blur', saveSettings);
    document.getElementById('outdoor-brightness-source').addEventListener('change', () => {
      updateOutdoorSourceState();
      saveSettings();
    });
    document.getElementById('outdoor-lux-sensor').addEventListener('change', async function() {
      // Clear old baselines (they belong to the previous sensor)
      document.getElementById('lux-learned-ceiling').value = '';
      document.getElementById('lux-learned-floor').value = '';
      await saveSettings();
    });
    document.getElementById('lux-smoothing-interval').addEventListener('blur', saveSettings);
    document.getElementById('lux-learned-ceiling').addEventListener('blur', saveSettings);
    document.getElementById('lux-learned-floor').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-enabled').addEventListener('change', () => {
      updateCtCompState();
      saveSettings();
    });
    document.getElementById('ct-comp-begin').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-end').addEventListener('blur', saveSettings);
    document.getElementById('ct-comp-factor').addEventListener('blur', saveSettings);

    // Location functions
    function updateLocationSection(config) {
      const useHA = config.use_ha_location !== false;
      document.getElementById('use-ha-location').checked = useHA;
      document.getElementById('latitude').value = config.latitude || '';
      document.getElementById('longitude').value = config.longitude || '';
      document.getElementById('timezone').value = config.timezone || 'US/Eastern';
      updateLocationInputsState(useHA);
    }

    function updateLocationInputsState(useHA) {
      const fields = document.getElementById('location-fields');
      const inputs = fields.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = useHA);
      if (useHA) {
        fields.classList.add('disabled');
      } else {
        fields.classList.remove('disabled');
      }
    }

    async function saveLocationSettings() {
      const settings = {
        use_ha_location: document.getElementById('use-ha-location').checked,
        latitude: parseFloat(document.getElementById('latitude').value) || null,
        longitude: parseFloat(document.getElementById('longitude').value) || null,
        timezone: document.getElementById('timezone').value
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving location:', err);
      }
    }

    document.getElementById('use-ha-location').addEventListener('change', (e) => {
      updateLocationInputsState(e.target.checked);
      saveLocationSettings();
    });

    ['latitude', 'longitude', 'timezone'].forEach(id => {
      document.getElementById(id).addEventListener('change', saveLocationSettings);
    });

    // ---- Light Filters ----
    let filterPresets = {};

    function renderFilterPresets() {
      const container = document.getElementById('filter-presets-list');
      container.innerHTML = '';
      for (const [name, preset] of Object.entries(filterPresets)) {
        const isStandard = name === 'Standard';
        const row = document.createElement('div');
        row.className = 'filter-preset-row';
        row.innerHTML = `
          <div class="filter-preset-name">
            ${isStandard ? `<span>${name}</span>` : `<input type="text" value="${name}" data-orig="${name}" onblur="renamePreset(this)" />`}
          </div>
          <div class="filter-slider-group">
            <label>at bright</label>
            <input type="range" min="0" max="200" step="1" value="${preset.at_bright}" oninput="updatePresetSlider(this, '${name}', 'at_bright')">
            <span class="filter-slider-value">${preset.at_bright}%</span>
          </div>
          <div class="filter-slider-group">
            <label>at dim</label>
            <input type="range" min="0" max="200" step="1" value="${preset.at_dim}" oninput="updatePresetSlider(this, '${name}', 'at_dim')">
            <span class="filter-slider-value">${preset.at_dim}%</span>
          </div>
          <div class="filter-slider-group">
            <label>off below</label>
            <input type="range" min="0" max="20" step="1" value="${preset.off_threshold ?? 3}" oninput="updatePresetSlider(this, '${name}', 'off_threshold')">
            <span class="filter-slider-value">${preset.off_threshold ?? 3}%</span>
          </div>
          ${isStandard ? '<div style="width:28px"></div>' : `<button class="filter-preset-delete" onclick="deletePreset('${name}')" title="Delete preset">&times;</button>`}
        `;
        container.appendChild(row);
      }
    }

    function updatePresetSlider(slider, presetName, field) {
      slider.nextElementSibling.textContent = slider.value + '%';
      filterPresets[presetName][field] = parseInt(slider.value);
      saveFilterPresets();
    }

    function renamePreset(input) {
      const orig = input.dataset.orig;
      const newName = input.value.trim();
      if (!newName || newName === orig) {
        input.value = orig;
        return;
      }
      if (filterPresets[newName]) {
        input.value = orig;
        return;
      }
      const data = filterPresets[orig];
      delete filterPresets[orig];
      filterPresets[newName] = data;
      renderFilterPresets();
      saveFilterPresets();
    }

    async function deletePreset(name) {
      if (name === 'Standard') return;

      // Check if any lights are assigned to this preset
      let usageLines = [];
      try {
        const resp = await fetch('./api/light-filters');
        if (resp.ok) {
          const data = await resp.json();
          const areaLights = data.area_lights || {};
          for (const [zoneName, zone] of Object.entries(data.zones || {})) {
            for (const area of zone.areas || []) {
              const filters = area.light_filters || {};
              const matching = Object.entries(filters)
                .filter(([eid, preset]) => preset === name)
                .map(([eid]) => {
                  const lights = areaLights[area.id] || [];
                  const found = lights.find(l => l.entity_id === eid);
                  return found ? found.name : eid;
                });
              if (matching.length > 0) {
                usageLines.push(`- ${area.name}: ${matching.join(', ')}`);
              }
            }
          }
        }
      } catch (e) {
        // If fetch fails, proceed with simple confirm
      }

      if (usageLines.length > 0) {
        const count = usageLines.reduce((n, line) => n + (line.match(/,/g) || []).length + 1, 0);
        const msg = `"${name}" is assigned to ${count} light${count !== 1 ? 's' : ''}:\n${usageLines.join('\n')}\n\nDelete and reassign these lights to Standard?`;
        if (!confirm(msg)) return;
        try {
          await fetch('./api/light-filters/reassign-preset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({from_preset: name, to_preset: 'Standard'})
          });
        } catch (e) {
          alert('Failed to reassign lights: ' + e.message);
          return;
        }
      } else {
        if (!confirm(`Delete "${name}"?`)) return;
      }

      delete filterPresets[name];
      renderFilterPresets();
      saveFilterPresets();
    }

    function addFilterPreset() {
      let name = 'Custom';
      let i = 1;
      while (filterPresets[name]) { name = 'Custom ' + (++i); }
      filterPresets[name] = { at_bright: 100, at_dim: 100, off_threshold: 3 };
      renderFilterPresets();
      saveFilterPresets();
    }

    async function saveFilterPresets() {
      const lightFilters = {
        presets: filterPresets
      };
      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ light_filters: lightFilters })
        });
        if (response.ok) showSaveStatus();
      } catch (err) {
        console.error('Error saving filter presets:', err);
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSettings();
      // Load filter presets
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          const lf = config.light_filters || {};
          filterPresets = lf.presets || {
            "Standard": {"at_bright": 100, "at_dim": 100, "off_threshold": 3},
            "Overhead": {"at_bright": 100, "at_dim": 0, "off_threshold": 3},
            "Lamp": {"at_bright": 30, "at_dim": 100, "off_threshold": 3},
            "Accent": {"at_bright": 50, "at_dim": 50, "off_threshold": 3},
            "Nightlight": {"at_bright": 0, "at_dim": 40, "off_threshold": 3}
          };
          renderFilterPresets();
        }
      } catch (err) {
        console.error('Error loading filter presets:', err);
      }
    });
  </script>
</body>
</html>
