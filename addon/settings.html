<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circadian Light - Advanced</title>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --card: #1a1a1a;
      --accent: #feac60;
      --accent-hover: #ffc078;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --line: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-right: 32px;
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 8px 16px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    /* Main Content */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Settings Sections */
    .settings-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section-header {
      background: var(--panel);
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-content {
      padding: 20px;
    }

    .section-content.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Form Controls */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-label {
      min-width: 160px;
      font-size: 0.9rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-control {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-input {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      width: 200px;
    }

    .form-input:focus {
      outline: 2px solid var(--accent);
    }

    /* Hide number input spinners to prevent accidental value changes on click */
    .form-input[type="number"]::-webkit-inner-spin-button,
    .form-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .form-input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--muted2);
      margin-left: 12px;
    }

    /* Info Icon */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 10px;
      font-style: italic;
      color: rgba(255,255,255,0.5);
      cursor: help;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      color: rgba(255,255,255,0.8);
      border-color: rgba(255,255,255,0.5);
    }

    .info-tooltip {
      display: none;
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      width: 280px;
      font-size: 0.8rem;
      font-style: normal;
      color: var(--muted);
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .info-icon:hover .info-tooltip {
      display: block;
    }

    /* Save Status */
    .save-status {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
    }

    .save-status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Checkbox */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .form-row.disabled {
      opacity: 0.5;
    }

    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <span class="nav-brand">Circadian Light</span>
    <div class="nav-links">
      <a href="./" class="nav-link">Home</a>
      <a href="./glo" class="nav-link">Glo design</a>
      <a href="./areas" class="nav-link">Areas</a>
      <a href="./switches" class="nav-link">Controls</a>
      <a href="./settings" class="nav-link active">Advanced</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">Advanced</h1>
    </div>

    <!-- Timing Section -->
    <div class="settings-section">
      <div class="section-header">Timing</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Turn on lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns on lights, they'll smoothly turn on over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-on-transition" min="0" max="100" step="1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Turn off lights speed
            <span class="info-icon">i<span class="info-tooltip">When Circadian Light turns off lights, they'll smoothly turn off over this amount of time.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="turn-off-transition" min="0" max="100" step="1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Two-step delay
            <span class="info-icon">i<span class="info-tooltip">When turning on lights, a two-step process sets color at 1% then transitions to target brightness. This delay between steps prevents some ZigBee lights from dropping the second command. Increase if lights stay dim after turn-on.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="two-step-delay" min="0" max="20" step="0.1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Multi-click
            <span class="info-icon">i<span class="info-tooltip">For switches controlled by a hub that doesn't support double-clicks, triple-clicks, etc. (e.g. the Philips Hue Hub), enabling turns on Circadian Light detection of multi-clicks. Single-click actions will be delayed by the multi-click speed while waiting for additional clicks.</span></span>
          </label>
          <div class="form-control">
            <label class="checkbox-label">
              <input type="checkbox" id="multi-click-enabled">
            </label>
            <span id="multi-click-speed-group" style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
              <span class="form-hint" style="margin-left: 0;">Speed</span>
              <input type="number" class="form-input" id="multi-click-speed" min="2" max="10" step="1" value="2" style="width: 60px;">
              <span class="form-hint">tenths</span>
            </span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Circadian refresh
            <span class="info-icon">i<span class="info-tooltip">How often Circadian Light updates the lights to match the current sun position. Also controls how quickly motion and boost timers are checked for expiration. Lower values give more precise timer cutoffs but increase Home Assistant API calls.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="circadian-refresh" min="5" max="120" step="5" value="30" style="width: 80px;">
            <span class="form-hint">seconds (5-120)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Sync refresh
            <span class="info-icon">i<span class="info-tooltip">How often Circadian Light checks for area membership changes (new areas, moved lights, added lights) and syncs ZHA groups. Expressed as a multiplier of the Circadian refresh interval. For example, 5x with a 30s refresh means sync runs every 150 seconds.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="sync-refresh-multiplier" min="2" max="20" step="1" value="5" style="width: 80px;">
            <span class="form-hint" id="sync-refresh-hint">x (every <span id="sync-interval-display">150</span>s)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Visual Feedback Section -->
    <div class="settings-section">
      <div class="section-header">Visual Feedback</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Motion warning time
            <span class="info-icon">i<span class="info-tooltip">How long before the motion timer expires to trigger a warning dim. Set to 0 to disable motion warnings. The warning dims lights to alert you before they turn off.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-time" min="0" max="120" step="5" value="0" style="width: 80px;">
            <span class="form-hint">seconds before off (0 = disabled)</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning blink threshold
            <span class="info-icon">i<span class="info-tooltip">At low brightness levels, a simple dim may not be noticeable. Below this threshold, the warning will briefly blink off (0% for 300ms) before dimming to ensure you notice. Formula: above threshold dims to 50% of current; below threshold blinks then dims to 3%.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="motion-warning-blink-threshold" min="5" max="50" step="1" value="15" style="width: 80px;">
            <span class="form-hint">% brightness</span>
          </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label class="form-label">
            Freeze off rise speed
            <span class="info-icon">i<span class="info-tooltip">When unfreezing, lights rise back to circadian values over this amount of time. A slower rise gives a gentle visual confirmation that the area has been unfrozen.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="freeze-off-rise" min="0" max="100" step="1" value="10" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Limit warning speed
            <span class="info-icon">i<span class="info-tooltip">When stepping up/down hits the brightness or color limit, lights bounce to indicate the limit. This controls how fast the bounce animation plays.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="limit-warning-speed" min="0" max="100" step="1" value="3" style="width: 80px;">
            <span class="form-hint">tenths of a second</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning intensity
            <span class="info-icon">i<span class="info-tooltip">Base depth of the dip/flash when hitting a step limit. Higher values produce a more noticeable bounce effect.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="warning-intensity" min="1" max="10" step="1" value="5" style="width: 80px;">
            <span class="form-hint">1-10</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">
            Warning scaling
            <span class="info-icon">i<span class="info-tooltip">How much the bounce depth increases based on proximity to the opposite limit. Higher values make the bounce deeper when you have more room on the opposite side.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="warning-scaling" min="1" max="10" step="1" value="5" style="width: 80px;">
            <span class="form-hint">1-10</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Light Properties Section -->
    <div class="settings-section">
      <div class="section-header">Light Properties</div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">
            Boost default
            <span class="info-icon">i<span class="info-tooltip">When using the Boost action, lights will temporarily increase to maximum brightness plus this percentage offset from their current position. The boost will expire and return to normal circadian values.</span></span>
          </label>
          <div class="form-control">
            <input type="number" class="form-input" id="boost-default" min="10" max="100" step="5" value="30" style="width: 80px;">
            <span class="form-hint">%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="save-status" id="save-status">Settings saved</div>
  </main>

  <script>
    // Load and save settings
    async function loadSettings() {
      try {
        const response = await fetch('./api/config');
        if (response.ok) {
          const config = await response.json();
          document.getElementById('turn-on-transition').value = config.turn_on_transition ?? 3;
          document.getElementById('turn-off-transition').value = config.turn_off_transition ?? 3;
          document.getElementById('two-step-delay').value = config.two_step_delay ?? 3;
          document.getElementById('multi-click-enabled').checked = config.multi_click_enabled ?? true;
          document.getElementById('multi-click-speed').value = config.multi_click_speed ?? 2;
          document.getElementById('circadian-refresh').value = config.circadian_refresh ?? 30;
          document.getElementById('sync-refresh-multiplier').value = config.sync_refresh_multiplier ?? 5;
          document.getElementById('motion-warning-time').value = config.motion_warning_time ?? 0;
          document.getElementById('motion-warning-blink-threshold').value = config.motion_warning_blink_threshold ?? 15;
          document.getElementById('freeze-off-rise').value = config.freeze_off_rise ?? 10;
          document.getElementById('limit-warning-speed').value = config.limit_warning_speed ?? 3;
          document.getElementById('warning-intensity').value = config.warning_intensity ?? 5;
          document.getElementById('warning-scaling').value = config.warning_scaling ?? 5;
          document.getElementById('boost-default').value = config.boost_default ?? 30;
          updateMultiClickState();
          updateSyncIntervalDisplay();
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function saveSettings() {
      const settings = {
        turn_on_transition: parseInt(document.getElementById('turn-on-transition').value) || 3,
        turn_off_transition: parseInt(document.getElementById('turn-off-transition').value) || 3,
        two_step_delay: parseFloat(document.getElementById('two-step-delay').value) || 3,
        multi_click_enabled: document.getElementById('multi-click-enabled').checked,
        multi_click_speed: parseInt(document.getElementById('multi-click-speed').value) || 2,
        circadian_refresh: parseInt(document.getElementById('circadian-refresh').value) || 30,
        sync_refresh_multiplier: parseInt(document.getElementById('sync-refresh-multiplier').value) || 5,
        motion_warning_time: parseInt(document.getElementById('motion-warning-time').value) || 0,
        motion_warning_blink_threshold: parseInt(document.getElementById('motion-warning-blink-threshold').value) || 15,
        freeze_off_rise: parseInt(document.getElementById('freeze-off-rise').value) || 10,
        limit_warning_speed: parseInt(document.getElementById('limit-warning-speed').value) || 3,
        warning_intensity: parseInt(document.getElementById('warning-intensity').value) || 5,
        warning_scaling: parseInt(document.getElementById('warning-scaling').value) || 5,
        boost_default: parseInt(document.getElementById('boost-default').value) || 30
      };

      try {
        const response = await fetch('./api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showSaveStatus();
        }
      } catch (err) {
        console.error('Error saving settings:', err);
      }
    }

    function updateMultiClickState() {
      const enabled = document.getElementById('multi-click-enabled').checked;
      const speedGroup = document.getElementById('multi-click-speed-group');
      const speedInput = document.getElementById('multi-click-speed');

      if (enabled) {
        speedGroup.style.opacity = '1';
        speedInput.disabled = false;
      } else {
        speedGroup.style.opacity = '0.4';
        speedInput.disabled = true;
      }
    }

    function updateSyncIntervalDisplay() {
      const refresh = parseInt(document.getElementById('circadian-refresh').value) || 30;
      const multiplier = parseInt(document.getElementById('sync-refresh-multiplier').value) || 5;
      document.getElementById('sync-interval-display').textContent = refresh * multiplier;
    }

    function showSaveStatus() {
      const status = document.getElementById('save-status');
      status.classList.add('visible');
      setTimeout(() => status.classList.remove('visible'), 2000);
    }

    // Auto-save on blur for number inputs (avoids decrement bug on focus)
    document.getElementById('turn-on-transition').addEventListener('blur', saveSettings);
    document.getElementById('turn-off-transition').addEventListener('blur', saveSettings);
    document.getElementById('two-step-delay').addEventListener('blur', saveSettings);
    document.getElementById('multi-click-enabled').addEventListener('change', () => {
      updateMultiClickState();
      saveSettings();
    });
    document.getElementById('multi-click-speed').addEventListener('blur', saveSettings);
    document.getElementById('circadian-refresh').addEventListener('blur', () => {
      updateSyncIntervalDisplay();
      saveSettings();
    });
    document.getElementById('sync-refresh-multiplier').addEventListener('blur', () => {
      updateSyncIntervalDisplay();
      saveSettings();
    });
    document.getElementById('motion-warning-time').addEventListener('blur', saveSettings);
    document.getElementById('motion-warning-blink-threshold').addEventListener('blur', saveSettings);
    document.getElementById('freeze-off-rise').addEventListener('blur', saveSettings);
    document.getElementById('limit-warning-speed').addEventListener('blur', saveSettings);
    document.getElementById('warning-intensity').addEventListener('blur', saveSettings);
    document.getElementById('warning-scaling').addEventListener('blur', saveSettings);
    document.getElementById('boost-default').addEventListener('blur', saveSettings);

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadSettings);
  </script>
</body>
</html>
