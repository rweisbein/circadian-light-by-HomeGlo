<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circadian Light - Moments</title>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --card: #1a1a1a;
      --accent: #feac60;
      --accent-hover: #ffc078;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --line: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 0 24px;
      display: flex;
      align-items: center;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-right: 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand.active {
      color: var(--accent);
    }

    .nav-logo {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .nav-link {
      padding: 8px 10px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: var(--accent);
    }


    /* Nav overflow menu */
    .nav-more { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: none; flex-shrink: 0; letter-spacing: 2px; line-height: 1; }
    .nav-more:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow { display: none; position: absolute; top: 100%; right: 12px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 4px 0; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 200; }
    .nav-overflow.open { display: block; }
    .nav-overflow-item { display: block; padding: 10px 16px; color: var(--muted); text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
    .nav-overflow-item:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-overflow-item.active { color: var(--accent); }

    /* Main Content */
    .main {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    .panel-header {
      padding: 0 4px 16px;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .moment-list {
      display: flex;
      flex-direction: column;
    }

    .moment-category {
      margin-bottom: 16px;
    }

    .category-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px 4px;
    }

    .moment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text);
      text-decoration: none;
    }

    .moment-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .moment-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      opacity: 0.8;
    }

    .moment-name {
      font-size: 0.9rem;
      font-weight: 500;
      flex: 1;
    }

    .moment-chevron {
      color: var(--muted2);
      font-size: 0.8rem;
    }

    .add-moment-btn {
      margin: 12px 0;
      padding: 10px 16px;
      background: transparent;
      border: 1px dashed var(--line);
      border-radius: 8px;
      color: var(--muted);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .add-moment-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="./" class="nav-brand">
      <svg class="nav-logo" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#555"/>
        <path d="M20 1 A19 19 0 0 1 20 39 Q20 28 8 20 Q20 12 20 1" fill="#ccc"/>
        <circle cx="20" cy="12" r="5" fill="#fff"/>
        <line x1="20" y1="3" x2="20" y2="5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="27" y1="6" x2="25.5" y2="7.5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <line x1="29" y1="12" x2="27" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <path d="M16 30 A6 6 0 1 1 24 30 A4.5 4.5 0 1 0 16 30" fill="#fff"/>
      </svg>
      Home
    </a>
    <div class="nav-links">
      <a href="./switches" class="nav-link">Control</a>
      <a href="./lights" class="nav-link">Light</a>
      <a href="./rhythm" class="nav-link">Rhythm</a>
      <a href="./moments" class="nav-link active">Magic</a>
      <a href="./settings" class="nav-link">Settings</a>
    </div>
    <button class="nav-more" aria-label="More pages">&middot;&middot;&middot;</button>
    <div class="nav-overflow"></div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="panel-header">
      <h2 class="panel-title">Moments</h2>
    </div>
    <div class="moment-list" id="moment-list">
      <!-- Populated by JS -->
    </div>
    <button class="add-moment-btn" onclick="createNewMoment()">
      <span>+</span> New Moment
    </button>
  </main>

  <script src="./shared.js"></script>
  <script>
    // State
    let moments = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadData();
      renderMomentList();
    });

    async function loadData() {
      try {
        const momentsRes = await fetch('./api/moments');
        if (momentsRes.ok) {
          const data = await momentsRes.json();
          moments = data.moments || {};
        }
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    function renderMomentList() {
      const container = document.getElementById('moment-list');

      // Group moments by category
      const byCategory = { utility: [], fun: [] };
      Object.entries(moments).forEach(([id, moment]) => {
        const cat = moment.category || 'utility';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push({ id, ...moment });
      });

      let html = '';
      ['utility', 'fun'].forEach(category => {
        const items = byCategory[category] || [];
        if (items.length > 0) {
          html += `
            <div class="moment-category">
              <div class="category-label">${category === 'utility' ? 'Utility' : 'Fun'}</div>
              ${items.map(m => `
                <a class="moment-item" href="./moment/${encodeURIComponent(m.id)}">
                  <span class="moment-icon">${m.icon || '&#127763;'}</span>
                  <span class="moment-name">${m.name}</span>
                  <span class="moment-chevron">&#8250;</span>
                </a>
              `).join('')}
            </div>
          `;
        }
      });

      if (Object.keys(moments).length === 0) {
        html = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <p>No moments yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Create your first moment to set whole-home lighting presets.</p>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function createNewMoment() {
      const newMoment = {
        name: 'New Moment',
        icon: '&#127763;',
        category: 'utility',
        trigger: { type: 'primitive' },
        default_action: 'off',
        exceptions: {}
      };

      try {
        const response = await fetch('./api/moments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newMoment)
        });

        if (response.ok) {
          const data = await response.json();
          window.location.href = './moment/' + encodeURIComponent(data.id);
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to create moment');
        }
      } catch (err) {
        console.error('Error creating moment:', err);
        alert('Error creating moment');
      }
    }
  </script>
</body>
</html>
