<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Circadian Light by HomeGlo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root {
  --bg: #000;
  --panel: #181818;
  --panel2: #252525;
  --text: #e6e6e6;
  --muted: #bbb;
  --muted2: #aaa;
  --line: #333;
  --line2: #2c2c2c;
  --grid: #202020;
  --accent: #1e90ff;
  --ascend: rgba(120, 190, 255, 0.32);
  --ascend-border: rgba(120, 185, 245, 0.5);
  --descend: #111;
  --descend-border: rgba(255, 230, 128, 0.45);
}
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
body { padding: 20px; }
h1 { margin: 0 0 18px; font-size: 28px; font-weight: 600; }
h2 { margin: 0 0 12px; font-size: 1.1rem; font-weight: 600; }

.container { max-width: 1200px; margin: 0 auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.header-actions { display: flex; gap: 12px; align-items: center; }

/* Activity Preset */
.activity-select { margin-bottom: 16px; }
.activity-select select {
  width: 100%;
  max-width: 300px;
  font-size: 1rem;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.06);
  color: #fff;
}

/* Section Blocks */
.section-block {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.section-block--ascend {
  background: var(--ascend);
  border-color: var(--ascend-border);
}
.section-block--ascend h2 { color: #7ec8ff; }
.section-block--descend {
  background: var(--descend);
  border-color: var(--descend-border);
}
.section-block--descend h2 { color: #ffd47a; }

/* Timing Grid */
.timing-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media (max-width: 768px) {
  .timing-grid { grid-template-columns: 1fr; }
}

/* Parameter Rows */
.param-row {
  display: grid;
  grid-template-columns: 140px 80px 1fr;
  align-items: center;
  gap: 12px;
  margin: 10px 0;
}
.param-row label {
  font-size: 0.9rem;
  color: var(--muted);
  font-weight: 600;
}
.param-row .value {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text);
  text-align: right;
}

/* Sliders */
input[type=range] {
  width: 100%;
  background: transparent;
  appearance: none;
  height: 20px;
  padding: 0;
  margin: 0;
}
input[type=range]:focus { outline: none; }
input[type=range]::-webkit-slider-runnable-track {
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
}
input[type=range]::-moz-range-track {
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
}
input[type=range]::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid rgba(0,0,0,0.3);
  margin-top: -6px;
  cursor: pointer;
}
input[type=range]::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid rgba(0,0,0,0.3);
  cursor: pointer;
}

/* Chart Section */
#chart { height: 400px; }
.chart-date-control {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}
.chart-date-display {
  font-size: 0.9rem;
  color: var(--muted);
  min-width: 80px;
}

/* Cursor Controls */
.cursor-controls {
  display: flex;
  justify-content: center;
  gap: 60px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--line);
}
.cursor-stack {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.cursor-stack-label {
  font-size: 0.85rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.cursor-btn-row {
  display: flex;
  gap: 8px;
}
.cursor-btn {
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 8px 20px;
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.15s;
}
.cursor-btn:hover {
  border-color: rgba(255,255,255,0.5);
  background: rgba(255,255,255,0.1);
}
.cursor-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Dual Range Slider */
.dual-range {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
}
.dual-track {
  position: relative;
  flex: 1;
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
}
.dual-fill {
  position: absolute;
  top: 0;
  height: 4px;
  background: var(--accent);
  border-radius: 2px;
}
.dual-range input[type=range] {
  position: absolute;
  width: 100%;
  background: transparent;
}
.dual-chip {
  font-size: 0.85rem;
  color: var(--muted);
  min-width: 60px;
}
.dual-chip.right { text-align: right; }

/* Solar Rules */
.solar-rule {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 16px;
  align-items: start;
  padding: 12px 0;
  border-bottom: 1px solid var(--line);
}
.solar-rule:last-child { border-bottom: none; }
.solar-rule-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.solar-rule-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text);
}
.solar-rule-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
}
.solar-rule-toggle input[type=checkbox] {
  width: 18px;
  height: 18px;
  accent-color: #7CFF72;
}
.solar-rule-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}
.solar-rule-controls select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--line);
  background: var(--panel2);
  color: var(--text);
}
.temp-chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
}

/* Buttons */
.btn {
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.1);
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.15s;
}
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary {
  background: var(--accent);
  border-color: var(--accent);
}
.btn-primary:hover { filter: brightness(1.1); }

/* Status Messages */
.success {
  color: #51cf66;
  font-size: 0.9rem;
  margin: 10px 0;
  padding: 12px 16px;
  background: rgba(81,207,102,0.15);
  border: 1px solid rgba(81,207,102,0.3);
  border-radius: 8px;
  font-weight: 600;
}
.error {
  color: #ff6b6b;
  font-size: 0.9rem;
  margin: 10px 0;
  padding: 12px 16px;
  background: rgba(255,107,107,0.15);
  border: 1px solid rgba(255,107,107,0.3);
  border-radius: 8px;
  font-weight: 600;
}

/* Responsive */
@media (max-width: 640px) {
  .param-row { grid-template-columns: 1fr; gap: 4px; }
  .cursor-controls { flex-wrap: wrap; gap: 24px; }
  .solar-rule { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Circadian Light by HomeGlo</h1>
    <div class="header-actions">
      <button id="save-config" class="btn btn-primary">Save Configuration</button>
    </div>
  </div>
  <div id="save-status"></div>

  <!-- Activity Preset -->
  <div class="activity-select">
    <label for="activity-preset">Activity Preset</label>
    <select id="activity-preset">
      <option value="young">Young Child</option>
      <option value="adult" selected>Adult</option>
      <option value="nightowl">Night Owl</option>
      <option value="duskbat">Dusk Bat</option>
      <option value="shiftearly">Early Shift Worker</option>
      <option value="shiftlate">Late Shift Worker</option>
    </select>
  </div>

  <!-- Ascend/Descend Timing -->
  <div class="timing-grid">
    <div class="section-block section-block--ascend">
      <h2>Ascend</h2>
      <div class="param-row">
        <label>Ascend starts</label>
        <span class="value" id="ascend-start-display">3:00a</span>
        <input type="range" id="ascend-start" min="0" max="24" step="0.5" value="3">
      </div>
      <div class="param-row">
        <label>Wake time</label>
        <span class="value" id="wake-time-display">6:00a</span>
        <input type="range" id="wake-time" min="0" max="24" step="0.5" value="6">
      </div>
      <div class="param-row">
        <label>Wake speed</label>
        <span class="value" id="wake-speed-display">Fast (8)</span>
        <input type="range" id="wake-speed" min="1" max="10" step="1" value="8">
      </div>
    </div>

    <div class="section-block section-block--descend">
      <h2>Descend</h2>
      <div class="param-row">
        <label>Descend starts</label>
        <span class="value" id="descend-start-display">12:00p</span>
        <input type="range" id="descend-start" min="0" max="36" step="0.5" value="12">
      </div>
      <div class="param-row">
        <label>Bed time</label>
        <span class="value" id="bed-time-display">10:00p</span>
        <input type="range" id="bed-time" min="0" max="36" step="0.5" value="22">
      </div>
      <div class="param-row">
        <label>Bed speed</label>
        <span class="value" id="bed-speed-display">Crisp (6)</span>
        <input type="range" id="bed-speed" min="1" max="10" step="1" value="6">
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="section-block">
    <div class="chart-date-control">
      <span class="chart-date-display" id="chart-date-display">Today</span>
      <input type="range" id="chart-date-slider" min="0" max="364" value="0">
    </div>
    <div id="chart"></div>

    <!-- Cursor Controls -->
    <div class="cursor-controls">
      <div class="cursor-stack">
        <span class="cursor-stack-label">Step</span>
        <div class="cursor-btn-row">
          <button class="cursor-btn" id="cursor-step-up" title="Step Up">↑</button>
          <button class="cursor-btn" id="cursor-step-down" title="Step Down">↓</button>
        </div>
      </div>
      <div class="cursor-stack">
        <span class="cursor-stack-label">Bright</span>
        <div class="cursor-btn-row">
          <button class="cursor-btn" id="cursor-bright-up" title="Brighten">↑</button>
          <button class="cursor-btn" id="cursor-bright-down" title="Dim">↓</button>
        </div>
      </div>
      <div class="cursor-stack">
        <span class="cursor-stack-label">Color</span>
        <div class="cursor-btn-row">
          <button class="cursor-btn" id="cursor-color-up" title="Cooler">↑</button>
          <button class="cursor-btn" id="cursor-color-down" title="Warmer">↓</button>
        </div>
      </div>
      <div class="cursor-stack">
        <button class="btn" id="cursor-reset">Reset</button>
      </div>
    </div>
  </div>

  <!-- Brightness & Color Range -->
  <div class="section-block">
    <h2>Brightness &amp; Color</h2>

    <div class="param-row" style="grid-template-columns: 140px 60px 1fr 60px;">
      <label>Color range</label>
      <span class="dual-chip" id="color-min-display">500 K</span>
      <div class="dual-range">
        <div class="dual-track">
          <div class="dual-fill" id="color-fill"></div>
        </div>
        <input type="range" id="color-min" min="500" max="6500" step="100" value="500">
        <input type="range" id="color-max" min="500" max="6500" step="100" value="6500">
      </div>
      <span class="dual-chip right" id="color-max-display">6500 K</span>
    </div>

    <div class="param-row" style="grid-template-columns: 140px 60px 1fr 60px;">
      <label>Brightness range</label>
      <span class="dual-chip" id="brightness-min-display">1%</span>
      <div class="dual-range">
        <div class="dual-track">
          <div class="dual-fill" id="brightness-fill"></div>
        </div>
        <input type="range" id="brightness-min" min="1" max="100" step="1" value="1">
        <input type="range" id="brightness-max" min="1" max="100" step="1" value="100">
      </div>
      <span class="dual-chip right" id="brightness-max-display">100%</span>
    </div>

    <div class="param-row">
      <label>Step increments</label>
      <span class="value" id="step-count-display">10 steps</span>
      <input type="range" id="step-count" min="1" max="50" step="1" value="10">
    </div>
  </div>

  <!-- Solar Color Rules -->
  <div class="section-block">
    <h2>Solar Color Rules</h2>

    <div class="solar-rule">
      <div class="solar-rule-header">
        <span class="solar-rule-title">Warm at night</span>
        <div class="solar-rule-toggle">
          <input type="checkbox" id="warm-night-enabled">
          <label for="warm-night-enabled">Enable</label>
        </div>
      </div>
      <div class="solar-rule-controls">
        <select id="warm-night-mode">
          <option value="all">All night</option>
          <option value="sunrise">Before sunrise</option>
          <option value="sunset">After sunset</option>
        </select>
        <span>Target:</span>
        <input type="range" id="warm-night-target" min="500" max="4000" step="100" value="2700" style="width:120px">
        <span id="warm-night-target-display">2700 K</span>
      </div>
    </div>

    <div class="solar-rule">
      <div class="solar-rule-header">
        <span class="solar-rule-title">Cool during day</span>
        <div class="solar-rule-toggle">
          <input type="checkbox" id="cool-day-enabled">
          <label for="cool-day-enabled">Enable</label>
        </div>
      </div>
      <div class="solar-rule-controls">
        <select id="cool-day-mode">
          <option value="all">All day</option>
        </select>
        <span>Target:</span>
        <input type="range" id="cool-day-target" min="4000" max="6500" step="100" value="6500" style="width:120px">
        <span id="cool-day-target-display">6500 K</span>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// Circadian Light Designer - Ascend/Descend Model
// ============================================================

const SPEED_LABELS = ['', 'Very Slow', 'Slow', 'Gentle', 'Soft', 'Medium', 'Crisp', 'Quick', 'Fast', 'Swift', 'Instant'];
const SPEED_TO_SLOPE = [0, 0.4, 0.6, 0.8, 1.0, 1.3, 1.7, 2.3, 3.0, 4.0, 5.5];

// Activity Presets
const ACTIVITY_PRESETS = {
  young: { wake_time: 6.0, bed_time: 18.0, ascend_start: 0.0, descend_start: 12.0 },
  adult: { wake_time: 6.0, bed_time: 22.0, ascend_start: 4.0, descend_start: 12.0 },
  nightowl: { wake_time: 10.0, bed_time: 2.0, ascend_start: 8.0, descend_start: 16.0 },
  duskbat: { wake_time: 14.0, bed_time: 6.0, ascend_start: 12.0, descend_start: 20.0 },
  shiftearly: { wake_time: 18.0, bed_time: 10.0, ascend_start: 16.0, descend_start: 0.0 },
  shiftlate: { wake_time: 22.0, bed_time: 14.0, ascend_start: 20.0, descend_start: 4.0 }
};

// State
let config = {
  ascend_start: 3.0,
  descend_start: 12.0,
  wake_time: 6.0,
  bed_time: 22.0,
  wake_speed: 8,
  bed_speed: 6,
  min_color_temp: 500,
  max_color_temp: 6500,
  min_brightness: 1,
  max_brightness: 100,
  max_dim_steps: 10,
  warm_night_enabled: false,
  warm_night_mode: 'all',
  warm_night_target: 2700,
  cool_day_enabled: false,
  cool_day_mode: 'all',
  cool_day_target: 6500,
  activity_preset: 'adult',
  latitude: 35.0,
  longitude: -78.6,
  timezone: 'US/Eastern'
};

// Runtime midpoints (can diverge from base wake/bed times)
let runtimeState = {
  brightness_wake_mid: null,
  brightness_bed_mid: null,
  color_wake_mid: null,
  color_bed_mid: null
};

// ============================================================
// Utility Functions
// ============================================================

function formatHour(h) {
  const h24 = ((h % 24) + 24) % 24;
  const hr = Math.floor(h24);
  const min = Math.round((h24 - hr) * 60);
  const suffix = hr < 12 ? 'a' : 'p';
  const hr12 = hr === 0 ? 12 : (hr > 12 ? hr - 12 : hr);
  return min === 0 ? `${hr12}:00${suffix}` : `${hr12}:${min.toString().padStart(2, '0')}${suffix}`;
}

function logistic(x, midpoint, slope, y0, y1) {
  try {
    const expVal = Math.exp(-slope * (x - midpoint));
    return y0 + (y1 - y0) / (1 + expVal);
  } catch {
    return slope * (x - midpoint) > 0 ? y1 : y0;
  }
}

// 48-hour unwrapping for cross-midnight handling
function getNormalizedPhases(ascendStart, descendStart) {
  let ds = descendStart;
  if (ds <= ascendStart) ds += 24;
  return { ascendStart, descendStart: ds };
}

function unwrapHour48(hour, ascendStart) {
  return hour < ascendStart ? hour + 24 : hour;
}

function liftMidpoint(mid, phaseStart, phaseEnd) {
  let m = mid;
  while (m < phaseStart) m += 24;
  while (m > phaseEnd) m -= 24;
  return m;
}

// ============================================================
// Curve Calculation
// ============================================================

function calculateBrightnessAtHour(hour, cfg, runtime) {
  const { ascendStart, descendStart } = getNormalizedPhases(cfg.ascend_start, cfg.descend_start);
  const h48 = unwrapHour48(hour, ascendStart);

  const bMin = cfg.min_brightness / 100;
  const bMax = cfg.max_brightness / 100;

  const kAscend = SPEED_TO_SLOPE[cfg.wake_speed];
  const kDescend = SPEED_TO_SLOPE[cfg.bed_speed];

  const inAscend = h48 >= ascendStart && h48 < descendStart;

  const wakeMid = runtime.brightness_wake_mid ?? cfg.wake_time;
  const bedMid = runtime.brightness_bed_mid ?? cfg.bed_time;

  let value;
  if (inAscend) {
    const wakeMid48 = liftMidpoint(wakeMid, ascendStart, descendStart);
    value = logistic(h48, wakeMid48, kAscend, bMin, bMax);
  } else {
    const descendEnd = ascendStart + 24;
    const bedMid48 = liftMidpoint(bedMid, descendStart, descendEnd);
    value = logistic(h48, bedMid48, -kDescend, bMin, bMax);
  }

  return Math.max(cfg.min_brightness, Math.min(cfg.max_brightness, value * 100));
}

function calculateColorAtHour(hour, cfg, runtime) {
  const { ascendStart, descendStart } = getNormalizedPhases(cfg.ascend_start, cfg.descend_start);
  const h48 = unwrapHour48(hour, ascendStart);

  const cMin = cfg.min_color_temp;
  const cMax = cfg.max_color_temp;

  const kAscend = SPEED_TO_SLOPE[cfg.wake_speed];
  const kDescend = SPEED_TO_SLOPE[cfg.bed_speed];

  const inAscend = h48 >= ascendStart && h48 < descendStart;

  const colorWakeMid = runtime.color_wake_mid ?? cfg.wake_time;
  const colorBedMid = runtime.color_bed_mid ?? cfg.bed_time;

  let value;
  if (inAscend) {
    const wakeMid48 = liftMidpoint(colorWakeMid, ascendStart, descendStart);
    value = logistic(h48, wakeMid48, kAscend, cMin, cMax);
  } else {
    const descendEnd = ascendStart + 24;
    const bedMid48 = liftMidpoint(colorBedMid, descendStart, descendEnd);
    value = logistic(h48, bedMid48, -kDescend, cMin, cMax);
  }

  return Math.max(cfg.min_color_temp, Math.min(cfg.max_color_temp, value));
}

// ============================================================
// Chart Rendering
// ============================================================

function renderChart() {
  const hours = [];
  const brightness = [];
  const color = [];

  for (let h = 0; h < 24; h += 0.1) {
    hours.push(h);
    brightness.push(calculateBrightnessAtHour(h, config, runtimeState));
    color.push(calculateColorAtHour(h, config, runtimeState));
  }

  const briTrace = {
    x: hours,
    y: brightness,
    name: 'Brightness',
    type: 'scatter',
    mode: 'lines',
    line: { color: '#66b8ff', width: 2 },
    yaxis: 'y'
  };

  const colorTrace = {
    x: hours,
    y: color,
    name: 'Color Temp',
    type: 'scatter',
    mode: 'lines',
    line: { color: '#ffd47a', width: 2 },
    yaxis: 'y2'
  };

  const layout = {
    paper_bgcolor: 'transparent',
    plot_bgcolor: 'transparent',
    margin: { l: 60, r: 60, t: 20, b: 50 },
    xaxis: {
      title: '',
      range: [0, 24],
      tickvals: [config.ascend_start, config.wake_time, config.descend_start, config.bed_time % 24],
      ticktext: ['ascend starts', 'wake', 'descend starts', 'bed'],
      tickfont: { color: '#aaa', size: 11 },
      gridcolor: '#333',
      linecolor: '#444'
    },
    yaxis: {
      title: 'Brightness %',
      titlefont: { color: '#66b8ff' },
      tickfont: { color: '#66b8ff' },
      range: [0, 100],
      gridcolor: '#333',
      linecolor: '#444'
    },
    yaxis2: {
      title: 'Color Temp K',
      titlefont: { color: '#ffd47a' },
      tickfont: { color: '#ffd47a' },
      overlaying: 'y',
      side: 'right',
      range: [config.min_color_temp, config.max_color_temp],
      gridcolor: 'transparent'
    },
    showlegend: false,
    hovermode: 'x unified'
  };

  const chartConfig = { responsive: true, displayModeBar: false };

  Plotly.react('chart', [briTrace, colorTrace], layout, chartConfig);
}

// ============================================================
// UI Updates
// ============================================================

function updateDisplay(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function updateSliderValue(sliderId, displayId, formatter) {
  const slider = document.getElementById(sliderId);
  if (!slider) return;
  slider.addEventListener('input', () => {
    const val = parseFloat(slider.value);
    updateDisplay(displayId, formatter(val));
    syncConfigFromUI();
    renderChart();
  });
}

function syncConfigFromUI() {
  config.ascend_start = parseFloat(document.getElementById('ascend-start').value);
  config.descend_start = parseFloat(document.getElementById('descend-start').value) % 24;
  config.wake_time = parseFloat(document.getElementById('wake-time').value);
  config.bed_time = parseFloat(document.getElementById('bed-time').value) % 24;
  config.wake_speed = parseInt(document.getElementById('wake-speed').value);
  config.bed_speed = parseInt(document.getElementById('bed-speed').value);

  config.min_color_temp = parseInt(document.getElementById('color-min').value);
  config.max_color_temp = parseInt(document.getElementById('color-max').value);
  config.min_brightness = parseInt(document.getElementById('brightness-min').value);
  config.max_brightness = parseInt(document.getElementById('brightness-max').value);
  config.max_dim_steps = parseInt(document.getElementById('step-count').value);

  config.warm_night_enabled = document.getElementById('warm-night-enabled').checked;
  config.warm_night_mode = document.getElementById('warm-night-mode').value;
  config.warm_night_target = parseInt(document.getElementById('warm-night-target').value);
  config.cool_day_enabled = document.getElementById('cool-day-enabled').checked;
  config.cool_day_mode = document.getElementById('cool-day-mode').value;
  config.cool_day_target = parseInt(document.getElementById('cool-day-target').value);

  // Reset runtime midpoints when config changes
  resetRuntimeMidpoints();
}

function syncUIFromConfig() {
  document.getElementById('ascend-start').value = config.ascend_start;
  document.getElementById('descend-start').value = config.descend_start;
  document.getElementById('wake-time').value = config.wake_time;
  document.getElementById('bed-time').value = config.bed_time;
  document.getElementById('wake-speed').value = config.wake_speed;
  document.getElementById('bed-speed').value = config.bed_speed;

  document.getElementById('color-min').value = config.min_color_temp;
  document.getElementById('color-max').value = config.max_color_temp;
  document.getElementById('brightness-min').value = config.min_brightness;
  document.getElementById('brightness-max').value = config.max_brightness;
  document.getElementById('step-count').value = config.max_dim_steps;

  document.getElementById('warm-night-enabled').checked = config.warm_night_enabled;
  document.getElementById('warm-night-mode').value = config.warm_night_mode;
  document.getElementById('warm-night-target').value = config.warm_night_target;
  document.getElementById('cool-day-enabled').checked = config.cool_day_enabled;
  document.getElementById('cool-day-mode').value = config.cool_day_mode;
  document.getElementById('cool-day-target').value = config.cool_day_target;

  document.getElementById('activity-preset').value = config.activity_preset || 'adult';

  // Update displays
  updateDisplay('ascend-start-display', formatHour(config.ascend_start));
  updateDisplay('descend-start-display', formatHour(config.descend_start));
  updateDisplay('wake-time-display', formatHour(config.wake_time));
  updateDisplay('bed-time-display', formatHour(config.bed_time));
  updateDisplay('wake-speed-display', `${SPEED_LABELS[config.wake_speed]} (${config.wake_speed})`);
  updateDisplay('bed-speed-display', `${SPEED_LABELS[config.bed_speed]} (${config.bed_speed})`);
  updateDisplay('color-min-display', `${config.min_color_temp} K`);
  updateDisplay('color-max-display', `${config.max_color_temp} K`);
  updateDisplay('brightness-min-display', `${config.min_brightness}%`);
  updateDisplay('brightness-max-display', `${config.max_brightness}%`);
  updateDisplay('step-count-display', `${config.max_dim_steps} steps`);
  updateDisplay('warm-night-target-display', `${config.warm_night_target} K`);
  updateDisplay('cool-day-target-display', `${config.cool_day_target} K`);

  updateDualFills();
}

function updateDualFills() {
  // Color range fill
  const colorMin = parseInt(document.getElementById('color-min').value);
  const colorMax = parseInt(document.getElementById('color-max').value);
  const colorFill = document.getElementById('color-fill');
  if (colorFill) {
    const left = ((colorMin - 500) / 6000) * 100;
    const right = ((colorMax - 500) / 6000) * 100;
    colorFill.style.left = `${left}%`;
    colorFill.style.width = `${right - left}%`;
  }

  // Brightness range fill
  const briMin = parseInt(document.getElementById('brightness-min').value);
  const briMax = parseInt(document.getElementById('brightness-max').value);
  const briFill = document.getElementById('brightness-fill');
  if (briFill) {
    briFill.style.left = `${briMin}%`;
    briFill.style.width = `${briMax - briMin}%`;
  }
}

function resetRuntimeMidpoints() {
  runtimeState.brightness_wake_mid = config.wake_time;
  runtimeState.brightness_bed_mid = config.bed_time;
  runtimeState.color_wake_mid = config.wake_time;
  runtimeState.color_bed_mid = config.bed_time;
}

// ============================================================
// Event Handlers
// ============================================================

function setupEventListeners() {
  // Timing sliders
  updateSliderValue('ascend-start', 'ascend-start-display', formatHour);
  updateSliderValue('descend-start', 'descend-start-display', formatHour);
  updateSliderValue('wake-time', 'wake-time-display', formatHour);
  updateSliderValue('bed-time', 'bed-time-display', formatHour);
  updateSliderValue('wake-speed', 'wake-speed-display', v => `${SPEED_LABELS[v]} (${v})`);
  updateSliderValue('bed-speed', 'bed-speed-display', v => `${SPEED_LABELS[v]} (${v})`);

  // Range sliders
  updateSliderValue('color-min', 'color-min-display', v => `${v} K`);
  updateSliderValue('color-max', 'color-max-display', v => `${v} K`);
  updateSliderValue('brightness-min', 'brightness-min-display', v => `${v}%`);
  updateSliderValue('brightness-max', 'brightness-max-display', v => `${v}%`);
  updateSliderValue('step-count', 'step-count-display', v => `${v} steps`);

  // Solar rules
  updateSliderValue('warm-night-target', 'warm-night-target-display', v => `${v} K`);
  updateSliderValue('cool-day-target', 'cool-day-target-display', v => `${v} K`);

  ['warm-night-enabled', 'cool-day-enabled', 'warm-night-mode', 'cool-day-mode'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => { syncConfigFromUI(); renderChart(); });
  });

  // Activity preset
  document.getElementById('activity-preset').addEventListener('change', (e) => {
    const preset = ACTIVITY_PRESETS[e.target.value];
    if (preset) {
      config.activity_preset = e.target.value;
      config.wake_time = preset.wake_time;
      config.bed_time = preset.bed_time;
      config.ascend_start = preset.ascend_start;
      config.descend_start = preset.descend_start;
      resetRuntimeMidpoints();
      syncUIFromConfig();
      renderChart();
    }
  });

  // Cursor controls
  document.getElementById('cursor-step-up')?.addEventListener('click', () => stepCursor('up', true, true));
  document.getElementById('cursor-step-down')?.addEventListener('click', () => stepCursor('down', true, true));
  document.getElementById('cursor-bright-up')?.addEventListener('click', () => stepCursor('up', true, false));
  document.getElementById('cursor-bright-down')?.addEventListener('click', () => stepCursor('down', true, false));
  document.getElementById('cursor-color-up')?.addEventListener('click', () => stepCursor('up', false, true));
  document.getElementById('cursor-color-down')?.addEventListener('click', () => stepCursor('down', false, true));
  document.getElementById('cursor-reset')?.addEventListener('click', () => {
    resetRuntimeMidpoints();
    renderChart();
  });

  // Dual range fills
  ['color-min', 'color-max', 'brightness-min', 'brightness-max'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateDualFills);
  });

  // Save button
  document.getElementById('save-config')?.addEventListener('click', saveConfig);
}

function stepCursor(direction, adjustBrightness, adjustColor) {
  const stepSize = 0.5; // hours
  const sign = direction === 'up' ? 1 : -1;

  // Determine current phase based on current hour
  const now = new Date();
  const currentHour = now.getHours() + now.getMinutes() / 60;
  const { ascendStart, descendStart } = getNormalizedPhases(config.ascend_start, config.descend_start);
  const h48 = unwrapHour48(currentHour, ascendStart);
  const inAscend = h48 >= ascendStart && h48 < descendStart;

  if (adjustBrightness) {
    if (inAscend) {
      runtimeState.brightness_wake_mid = (runtimeState.brightness_wake_mid ?? config.wake_time) + sign * stepSize;
    } else {
      runtimeState.brightness_bed_mid = (runtimeState.brightness_bed_mid ?? config.bed_time) + sign * stepSize;
    }
  }

  if (adjustColor) {
    if (inAscend) {
      runtimeState.color_wake_mid = (runtimeState.color_wake_mid ?? config.wake_time) + sign * stepSize;
    } else {
      runtimeState.color_bed_mid = (runtimeState.color_bed_mid ?? config.bed_time) + sign * stepSize;
    }
  }

  renderChart();
}

// ============================================================
// API Communication
// ============================================================

async function loadConfig() {
  try {
    const resp = await fetch('./api/config');
    if (resp.ok) {
      const data = await resp.json();
      Object.assign(config, data);
      resetRuntimeMidpoints();
      syncUIFromConfig();
      renderChart();
    }
  } catch (err) {
    console.error('Error loading config:', err);
  }
}

async function saveConfig() {
  const statusEl = document.getElementById('save-status');
  try {
    const resp = await fetch('./api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(config)
    });

    if (resp.ok) {
      statusEl.innerHTML = '<div class="success">Configuration saved successfully!</div>';
    } else {
      statusEl.innerHTML = '<div class="error">Failed to save configuration</div>';
    }
  } catch (err) {
    statusEl.innerHTML = '<div class="error">Error saving configuration: ' + err.message + '</div>';
  }

  setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
}

// ============================================================
// Initialize
// ============================================================

document.addEventListener('DOMContentLoaded', () => {
  // Load saved config if available from server injection
  if (window.savedConfig) {
    Object.assign(config, window.savedConfig);
  }

  resetRuntimeMidpoints();
  setupEventListeners();
  syncUIFromConfig();
  renderChart();

  // Load config from API (will override if available)
  loadConfig();
});
</script>
</body>
</html>
